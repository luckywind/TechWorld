[实现ID-Mapping](https://cloud.tencent.com/developer/article/1719468)

[基于Spark的ID Mapping——Spark实现离线不相交集计算](https://cloud.tencent.com/developer/article/1610320?from=article.detail.1719468)



边数据不要自己checkpoint，会很慢

[数仓建模-OneID](https://developer.aliyun.com/article/897281)

1. 生成问题

   1. UUID可能会重复，且UUID没有意义，推荐使用MD5
2. 更新问题

   1. 图更新后，不能生成新的ID,而应该沿用老的，否则历史数据无法关联使用
3. 选择问题

   1. 其实就是两个子图的合并，合并后应该只有一个ID, 历史上却出现了多个，选择最老的那个，也可以简单的选择最小/最大的那个




设备指纹服务商：

<img src="https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image-20221222145021604.png" alt="image-20221222145021604" style="zoom:50%;" />

# DID

## 优势

1. 解决业务中基于不同设备ID的数据拉通问题
2. 隐私允许的情况下，最大程度拉通重置后的OAID
3. 保持DID的不变性
4. 下发至打点SDK，从根源实现数据一致性
5. 可插拔，灵活应对隐私政策的变更

## 评价

1. 设备各ID（如IMEI/OAID/AndroidID等）本身可能会随着谷歌&监管部门的政策而发生变化，但是DID是面向各ID的一个虚拟ID，可以很好的集中式应对政策的变化，以保持ID相对稳定且隐私合规，并对业务部门透明。所以，设备ID和用户ID本身是会不断进化的
2. ID-Mapping数据质量高，覆盖度和稳定性方面领先网易、58，不弱于美团与阿里

## 实现

埋点日志进入Talos,  Flink消费Talos的多个Topic，

1. ID优先级：定义了ID类型的优先级顺序，确保在处理过程中优先使用高优先级的ID类型。
2. **三级缓存**
   1. Flink状态缓存，存储当前设备的主ID以及关联的所有ID列表
   2. Pegasus数据库查询，状态缓存未命中时，会查询Pegasus数据库(多个Id 去碰撞)，根据优先级选择合适的设备ID
   3. 内存处理，在处理单条记录时，临时存储映射关系和状态信息
3. ID映射处理流程
   - 新设备处理：当所有缓存和数据库都未找到对应设备时，使用最高优先级的非空ID生成新的设备ID
   - id<->did 新映射关系写入Pegasus. 自动补全ID，确保后续事件可查询到完整映射

4. 冲突解决：多个ID映射到不同的did,优先选择高优先级ID对应的值

## 应用

1. 统计
2. 风控领域
   1. 垃圾注册、薅羊毛、刷单，app恶意刷下载量
3. 设备画像
4. 广告归因：例如，app的下载链接点击下载，判断两个渠道ID是否相同从而判断是否因为该链接而下载
5. 广告主进行广告投放计算，如果没有oneid,一个设备会被当成多个
6. 黑产识别： 风险评分，TZFID相对imei更难改写，通过TZFID对应的imei个数评级，判断风险系数，当前5%属于中风险
7. 做法： 维护设备ID倒排表，每来一批数据，按优先级逐一查倒排表，且总是基于更稳定的ID生成设备ID
8. 指标： 膨胀率4%，一致率99.6%

# 用户ID

小米业务比较复杂，一个用户在不同业务下产生的数据，没有一个很好的方式融合到一个用户身上，根本原因还是各业务使用的ID标识不统一（同一类型的ID，用不同处理方式），维度也不一样（不同主体），当业务发展到一定规模，我们更多的会考虑数据价值最大化，会去考虑跨业务间的融合，于是有了统一设备ID,统一用户ID等等。





[数据中台：OneData之One ID中用户体系ID-Mapping](https://blog.csdn.net/qq_22473611/article/details/112979839)

[用户体系搭建之ID-Mapping](https://www.biaodianfu.com/id-mapping.html)

ID-Mapping有非常多的用处，比如：

- 跨屏跟踪和跨设备跟踪，将一个用户的手机（App、小程序）、PC、平板等设备的上的行为信息串联到一起。
- 风险防控层面，通过模型识别可能存在用户、设备伪造问题。

# 行业方案

## 阿里

在阿里巴巴内部用户的ID类型包含：phone、PC cookie、IMEI与IDFA、淘宝账户、支付宝账户、邮箱等。而对于每个BU来说，他们知道的只是这个客户的片面属性，在开展营销活动时，只是针对一个手机号或一个邮箱做营销，但背后不能识别出来一个自然人、一个公司。为打破数据孤岛，创造更大的数据价值，阿里使用OneData作为核心方法论。

OneID 的做法是通过统一的实体识别和连接，打破数据孤岛，实现数据通融。简单来说，用户、设备等业务实体，在对应的业务数据中，会被映射为唯一识别（UID）上，其各个维度的数据通过这个 UID 进行关联。各个部门、业务、产品对业务实体的 UID 的定义和实现不一样，使得数据间无法直接关联，成为了数据孤岛。<font color=red>**基于手机号、身份证、邮箱、设备 ID 等信息，结合业务规则、机器学习、图算法等算法，进行 ID-Mapping，将各种 UID 都映射到统一 ID 上**</font>。通过这个统一 ID，便可关联起各个数据孤岛的数据，实现数据通融，以确保业务分析、用户画像等数据应用的准确和全面。

## 网易

结合各种账户、各种设备型号之间的关系对，以及设备使用规律等用户数据，采用规则规律、数据挖掘算法（连通图划分+社区发现）的方法，判别账户是否属于同一个人

![img](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/netease.png)

ID-Mapping过程中，常遇到的问题及对应方案如下：

- 用户有多个设备信息。解决方案：**定义相关的阈值进行关联**。社区发现当前应用于营销场景，暂未用于风控或用户运营场景，因为这种方式会把一些异常的账号关联在一起，且会存在仅登录使用过一次的设备信息。
- 设备过期，一般是2年半左右时间。解决方案：**设定衰减系数**，对单用户多设备加大衰减力度。

## 58同城

![img](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/58.png)

从图中可以看出，不同业务线所拥有的ID标识不一：

- 58同城：wuser、wbdid、wimei
- 58赶集：guser、gbdid、gapud、gimei
- 安居客：kimei

其中可以通过telep、bidua、appua、imei、idfa关联起来，由此建立不同ID之间的关联映射关系，就是ID-Mapping的过程。

## 美团

美团与大众点评进行了合并，那同一个用户在两个APP上有不同的身份标识，美团要怎样进行唯一标识呢？我们来看看美团和大众点评的账号体系。美团采用手机号、微信、微博、美团账号的登录方式；大众点评采用的手机号、微信、QQ、微博的登录方式；其交集为手机号、微信、微博。最终，对于注册用户账户体系，美团采用了手机号作为用户的唯一标识。

![img](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/meituan.png)

从上述案例可看出，ID-Mapping有三种常见方法：

- 基于账号体系企业中最常用的是基于账号体系来做ID的打通，用户注册时，给到用户一个uid，以uid来强关联所有注册用户的信息。
- 基于设备：那对于未注册用户可以通过终端设备ID精准识别，包含Android/iOS两类主流终端的识别。通过SDK将各种ID采集上报，后台利用的ID关系库和校准算法，实时生成/找回终端唯一ID并下发。
- 基于账号&设备：结合各种账户、各种设备型号之间的关系对，以及设备使用规律等用户数据，采用规则规律、数据挖掘算法的方法，输出关系稳定的ID关系对，并生成一个UID作为唯一识别该对象的标识码。

# ID-mapping实现方案

1. 按账号优先级，产生问题：用户设备的标识，没办法轻易定制一个规则来取某个作为唯一标识：
2. 借助图计算