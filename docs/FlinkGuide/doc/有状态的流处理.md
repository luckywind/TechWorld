[å‚è€ƒ](https://nightlies.apache.org/flink/flink-docs-release-1.13/docs/concepts/stateful-stream-processing/)

# ä»€ä¹ˆæ˜¯çŠ¶æ€ï¼Ÿ

æ¡ˆä¾‹ï¼š

1. æŸ¥æ‰¾æŸç±»eventï¼ŒçŠ¶æ€è®°å½•eventçš„é¡ºåº
2. å‘¨æœŸèšåˆevent, çŠ¶æ€è®°å½•ä¸­é—´ç»“æœ
3. åœ¨æ•°æ®æµä¸Šè®­ç»ƒåŠç³»å­¦ä¹ æ¨¡å‹ï¼ŒçŠ¶æ€è®°å½•å½“å‰ç‰ˆæœ¬æ¨¡å‹çš„å‚æ•°
4. ç®¡ç†å†å²æ•°æ®ï¼ŒçŠ¶æ€å…è®¸é«˜æ•ˆè·å–å†å²events

Flinkéœ€è¦çŸ¥é“çŠ¶æ€æ¥ä½¿ç”¨ [checkpoints](https://nightlies.apache.org/flink/flink-docs-release-1.13/docs/dev/datastream/fault-tolerance/checkpointing/) and [savepoints](https://nightlies.apache.org/flink/flink-docs-release-1.13/docs/ops/state/savepoints/).è¿›è¡Œå®¹é”™ã€‚

## Keyed State

Keyed stateå­˜å‚¨åœ¨å¯ä»¥è¢«ç†è§£ä¸ºå†…åµŒçš„k/vå­˜å‚¨é‡Œã€‚çŠ¶æ€å’Œå½“å‰Operatorè¯»å–çš„æµä¸€èµ·åˆ†åŒºå­˜å‚¨ï¼Œå› æ­¤åªå¯èƒ½åœ¨keyedæµè·å–çŠ¶æ€ã€‚

1. æŒ‰é”®åˆ†é…çŠ¶æ€æ‰€æœ‰çš„çŠ¶æ€æ›´æ–°éƒ½æ˜¯æœ¬åœ°æ“ä½œï¼Œæ— éœ€äº‹ç‰©å°±å¯ä»¥ä¿è¯ä¸€è‡´æ€§
2. è¿™ç§åˆ†é…æ–¹å¼å…è®¸Flinké‡æ–°åˆ†å‘çŠ¶æ€è°ƒæ•´åˆ†åŒº

![State and Partitioning](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/state_partitioning.svg)

æŒ‰é”®çŠ¶æ€ä»¥é”®ç»„çš„æ–¹å¼ç»„ç»‡ï¼Œæ˜¯Flinké‡æ–°åˆ†å‘çŠ¶æ€çš„åŸå­å•ä½ï¼Œé”®ç»„çš„ä¸ªæ•°å’Œå¹¶è¡Œåº¦ç›¸åŒï¼Œè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œç®—å­çš„æ¯ä¸ªå¹¶è¡Œå®ä¾‹å¤„ç†ä¸€ä¸ªæˆ–è€…å¤šä¸ªé”®ç»„

## çŠ¶æ€æŒä¹…åŒ–

Flinkä½¿ç”¨æµé‡æ”¾å’Œcheckpointå®ç°å®¹é”™ï¼Œcheckpointé—´éš”æ˜¯è¿è¡Œæ—¶å®¹é”™è´Ÿè½½ä¸æ¢å¤æ—¶é—´çš„ä¸€ç§æƒè¡¡ã€‚

## checkpoint

Flinkå®¹é”™çš„æ ¸å¿ƒæœºåˆ¶å°±æ˜¯åˆ†å¸ƒå¼æ•°æ®æµå’ŒçŠ¶æ€çš„ä¸€è‡´æ€§å¿«ç…§ï¼ŒåŸºäº  [Chandy-Lamport algorithm](http://research.microsoft.com/en-us/um/people/lamport/pubs/chandy.pdf) ä¸ºFlinké‡èº«å®šåšçš„ â€œ[Lightweight Asynchronous Snapshots for Distributed Dataflows](http://arxiv.org/abs/1506.08603)â€ è½»é‡çº§å¼‚æ­¥åˆ†å¸ƒå¼æ•°æ®æµå¿«ç…§ã€‚

Flink1.11å¼€å§‹checkpointå¯ä»¥ä¸å¯¹é½ï¼Œä¸‹é¢é¦–å…ˆæè¿°å¯¹é½çš„checkpoint

### Barriersä¸å¯¹é½checkpoint

barrieræ˜¯æ’å…¥åˆ°æ•°æ®æµä¸­ä½œä¸ºæµçš„ä¸€éƒ¨åˆ†ï¼ŒæŠŠæµåˆ‡åˆ†ä¸ºæµå…¥å½“å‰å¿«ç…§çš„å’Œæµå…¥ä¸‹ä¸€ä¸ªå¿«ç…§çš„æ•°æ®ã€‚barrierä¸ä¼šæ‰“æ–­æ•°æ®æµï¼Œå› æ­¤éå¸¸è½»é‡çº§ï¼ŒåŒæ—¶å¯ä»¥æœ‰å¤šä¸ªbarrierå­˜åœ¨ï¼Œä¹Ÿå°±æ˜¯è¯´å¤šä¸ªå¿«ç…§å¯ä»¥å¹¶è¡Œã€‚

![Checkpoint barriers in data streams](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/stream_barriers.svg)

barrieræ’å…¥åˆ°Sourceç®—å­é‡Œï¼Œæ’å…¥ä½ç½®å°±æ˜¯å½“å‰å¿«ç…§è¦†ç›–åˆ°çš„æ•°æ®ã€‚ä¾‹å¦‚kafkaï¼Œè¯¥ä½ç½®å°±æ˜¯åˆ†åŒºçš„æœ€åä¸€ä¸ªè®°å½•çš„offsetï¼Œè¿™ä¸ªä½ç½®ä¼šæŠ¥ç»™checkpoint coordinator(JobManager)ã€‚ 

ä¸­é—´ç®—å­æ¥æ”¶åˆ°æ‰€æœ‰ä¸Šæ¸¸çš„barrieråï¼Œä¹Ÿäº§ç”Ÿä¸€ä¸ªbarrierå¹¶åˆ†å‘åˆ°æ‰€æœ‰ä¸‹æ¸¸æµä¸­ã€‚Sinkç®—å­æ¥æ”¶åˆ°æ‰€æœ‰ä¸Šæ¸¸çš„barrieråé€šçŸ¥coordinatorï¼Œæ‰€æœ‰Sinkç®—å­éƒ½é€šçŸ¥coordinatoråï¼Œå°±æ„å‘³ç€è¿™ä¸ªå¿«ç…§å®Œæˆäº†ã€‚

ä¸€æ—¦å¿«ç…§å®Œæˆï¼Œjobå°±ä¸ä¼šå†æ¬¡è¯·æ±‚barrierä½ç½®ä¹‹å‰çš„æ•°æ®äº†ï¼Œå› ä¸ºï¼Œé‚£äº›æ•°æ®å·²ç»èµ°å®Œæ•´ä¸ªæµæ‹“æ‰‘äº†

![Aligning data streams at operators with multiple inputs](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/stream_aligning.svg)

æœ‰å¤šä¸ªä¸Šæ¸¸çš„ç®—å­éœ€è¦åœ¨å¿«ç…§barrierä½ç½®å¯¹é½ï¼Œä¸Šé¢ğŸ‘†è¿™ä¸ªå›¾è¯´æ˜ï¼š

- ç®—å­ä¸€æ—¦æ¥æ”¶åˆ°ä¸€ä¸ªä¸Šæ¸¸çš„barrierï¼Œç®—å­å°†ä¸èƒ½ç»§ç»­å¤„ç†è¯¥ä¸Šæ¸¸çš„æ•°æ®ï¼Œç›´åˆ°å…¶ä»–æ‰€æœ‰ä¸Šæ¸¸çš„barrieréƒ½åˆ°æ¥ã€‚å› ä¸ºï¼Œä¸è¿™æ ·çš„è¯ï¼Œå±äºå½“å‰å¿«ç…§çš„æ•°æ®å’Œå±äºä¸‹ä¸€ä¸ªå¿«ç…§çš„æ•°æ®å°†ä¼šæ··åœ¨ä¸€èµ·
- ä¸€æ—¦æœ€åä¸€ä¸ªä¸Šæ¸¸çš„barrieråˆ°æ¥ï¼Œç®—å­å°±å‘å‡ºé˜»å¡çš„æ•°æ®ï¼Œå¹¶ä¸”å‘å‡ºå½“å‰å¿«ç…§çš„barrier
- å¯¹çŠ¶æ€è¿›è¡Œå¿«ç…§ï¼Œç„¶åå¤„ç†input bufferï¼Œæ¥ç€ç»§ç»­å¤„ç†æ–°æ•°æ®
- æœ€åï¼Œå¼‚æ­¥æŠŠçŠ¶æ€å†™å…¥çŠ¶æ€åç«¯

### ç®—å­çŠ¶æ€å¿«ç…§

å¼€å§‹å¯¹çŠ¶æ€è¿›è¡Œå¿«ç…§çš„æ—¶é—´ç‚¹æ˜¯ç®—å­åœ¨æ¥æ”¶åˆ°æ‰€æœ‰è¾“å…¥çš„barrieråå’Œåˆ†å‘barrieråˆ°ä¸‹æ¸¸ä¹‹é—´ã€‚è¿™ä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§çš„ç‰¹ç‚¹æ˜¯åŒ…å«barrierä¹‹å‰æ‰€æœ‰æ•°æ®çš„çŠ¶æ€æ›´æ–°ï¼Œä¸åŒ…å«barrierä¹‹åæ‰€æœ‰æ•°æ®çš„çŠ¶æ€æ›´æ–°ã€‚

å¿«ç…§åŒ…å«ï¼š

- å¿«ç…§å¼€å§‹æ—¶æ¯ä¸ªSourceçš„offset/position
- æ¯ä¸ªç®—å­çš„çŠ¶æ€æŒ‡é’ˆ

<img src="https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/checkpointing.svg" alt="Illustration of the Checkpointing Mechanism" style="zoom:150%;" />

### æ¢å¤

è¿™ä¸ªæœºåˆ¶ä¸‹çš„æ¢å¤æ¯”è¾ƒç®€å•ï¼Œå‘ç”Ÿå¤±è´¥åï¼ŒFlinké€‰æ‹©æœ€åä¸€ä¸ªå®Œæˆçš„checkpoint kï¼Œé‡æ–°éƒ¨ç½²æ•°æ®æµï¼Œå¹¶ç»™å‡ºæ¯ä¸ªç®—å­çš„çŠ¶æ€ï¼ŒSourceå¯ä»¥ä»å¿«ç…§ä¸­è®°å½•çš„ä½ç½®å¼€å§‹æ¶ˆè´¹æ•°æ®ã€‚

### éå¯¹é½checkpoint

ç®—å­å¦‚ä½•å¤„ç†éå¯¹é½çš„barrierï¼Ÿ

![Unaligned checkpointing](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/stream_unaligning.svg)

- ç®—å­åœ¨input bufferç¬¬ä¸€æ¬¡çœ‹åˆ°barrieræ—¶ï¼Œç«‹å³æ”¾åˆ°output bufferçš„æœ€åï¼Œç«‹å³å‘å¾€ä¸‹æ¸¸

- ç®—å­æ ‡è®°ã€å¼‚æ­¥å­˜å‚¨è¶…è¿‡çš„æ•°æ®ï¼Œå¹¶åˆ›å»ºè‡ªå·±çš„çŠ¶æ€

  > è¶…è¿‡çš„æ•°æ®ï¼šæˆ‘çš„ç†è§£æ˜¯ç®—å­é‡åˆ°å½“å‰å¿«ç…§ç¬¬ä¸€ä¸ªbarrierå’Œæœ€åä¸€ä¸ªbarrierä¹‹é—´çš„æ•°æ®




### å¯¹é½vséå¯¹é½

1. Exactly Once æ—¶å¿…é¡» barrier å¯¹é½
2. å¦‚æœ barrier ä¸å¯¹é½å°±å˜æˆäº† At Least Onceã€‚
   CheckPoint çš„ç›®çš„å°±æ˜¯ä¸ºäº†ä¿å­˜å¿«ç…§ï¼Œå¦‚æœä¸å¯¹é½ï¼Œé‚£ä¹ˆåœ¨ chk-100 å¿«ç…§ä¹‹å‰ï¼Œå·²ç»å¤„ç†äº†ä¸€äº› chk-100 å¯¹åº”çš„ offset ä¹‹åçš„æ•°æ®ï¼Œå½“ç¨‹åºä» chk-100 æ¢å¤ä»»åŠ¡æ—¶ï¼Œchk-100 å¯¹åº”çš„ offset ä¹‹åçš„æ•°æ®è¿˜ä¼šè¢«å¤„ç†ä¸€æ¬¡ï¼Œæ‰€ä»¥å°±å‡ºç°äº†é‡å¤æ¶ˆè´¹



### çŠ¶æ€åç«¯

![checkpoints and snapshots](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/checkpoints.svg)

## savepoint

ä½¿ç”¨checkpointçš„æ‰€æœ‰ç¨‹åºéƒ½å¯ä»¥é‡æ–°ä»savepointæäº¤æ‰§è¡Œï¼Œsavepointå…è®¸æ›´æ–°ç¨‹åºè€Œä¸ä¸¢å¤±çŠ¶æ€ã€‚

æ˜¯æ‰‹åŠ¨è§¦å‘çš„checkpointï¼Œä¸”ä¸ä¼šå› ä¸ºæ–°çš„checkpointå®Œæˆäº†è€Œè¿‡æœŸã€‚

[Checkpoints vs. Savepoints](https://nightlies.apache.org/flink/flink-docs-release-1.15/zh/docs/ops/state/checkpoints_vs_savepoints/#checkpoints-vs-savepoints)

- æ¦‚å¿µï¼šCheckpoint æ˜¯ è‡ªåŠ¨å®¹é”™æœºåˆ¶ ï¼ŒSavepoint ç¨‹åºå…¨å±€çŠ¶æ€é•œåƒ ã€‚

- ç›®çš„ï¼š Checkpoint æ˜¯ç¨‹åºè‡ªåŠ¨å®¹é”™ï¼Œå¿«é€Ÿæ¢å¤ ã€‚Savepointæ˜¯ ç¨‹åºä¿®æ”¹åç»§ç»­ä»çŠ¶æ€æ¢å¤ï¼Œç¨‹åºå‡çº§ç­‰ã€‚

- ç”¨æˆ·äº¤äº’:Checkpoint æ˜¯ Flink ç³»ç»Ÿè¡Œä¸º ã€‚Savepointæ˜¯ç”¨æˆ·è§¦å‘ã€‚

- çŠ¶æ€æ–‡ä»¶ä¿ç•™ç­–ç•¥ï¼šCheckpointé»˜è®¤ç¨‹åºåˆ é™¤ï¼Œå¯ä»¥è®¾ç½®CheckpointConfigä¸­çš„å‚æ•°è¿›è¡Œä¿ç•™ ã€‚Savepointä¼šä¸€ç›´ä¿å­˜ï¼Œé™¤éç”¨æˆ·åˆ é™¤ ã€‚

#  [Exactly Once vs. At Least Once](https://nightlies.apache.org/flink/flink-docs-release-1.15/zh/docs/concepts/stateful-stream-processing/#exactly-once-vs-at-least-once)
