# 独立模式(Standalone)

## 会话模式部署

1. 启动netcat
   `nc -lk 7777`

2. 提交作业
   `flink run -m localhost:8081 -c com.atguigu.demo.chapter02.StreamWordCount FlinkTutorial-1.0-SNAPSHOT.jar --host localhost --port 7777`
   报错：org.apache.flink.client.program.ProgramInvocationException: The program's entry point class 'src/main/scala/com/atguigu/demo/chapter02/StreamWordCount.scala' was not found in the jar file.

   ```shell
   # 查看 JAR 内容
   jar tf target/FlinkTutorial-1.0-SNAPSHOT-jar-with-dependencies.jar
   
   # 应该包含类似路径
   com/atguigu/demo/chapter02/StreamWordCount.class
   ```


taskmanager的输出可以在WEB UI上和log里看到

## 应用模式部署

应用模式下不会提前创建集群，所以不能调用 start-cluster.sh 脚本。我们可以使用同样在 bin 目录下的 standalone-job.sh 来创建一个 JobManager。

具体步骤如下:
 (1)进入到 Flink 的安装路径下，将应用程序的 jar 包放到 lib/目录下。

```
$ cp ./FlinkTutorial-1.0-SNAPSHOT.jar lib/
```

(2)执行以下命令，启动 JobManager。
 `$ ./bin/standalone-job.sh start --job-classname com.atguigu.wc.StreamWordCount`

这里我们直接指定作业入口类，脚本会到 lib 目录扫描所有的 jar 包。

(3)同样是使用 bin 目录下的脚本，启动 TaskManager。

` $ ./bin/taskmanager.sh start`

(4)如果希望停掉集群，同样可以使用脚本，命令如下。

```shell
$ ./bin/standalone-job.sh stop
$ ./bin/taskmanager.sh stop
```

# checkpoint恢复测试

取消作业，并保存检查点

```shell
$flink cancel -s  file:///opt/homebrew/Cellar/apache-flink/1.19.1/libexec/save/ts/tt fddb2c9db9040d2d8cc71100482fcd90
DEPRECATION WARNING: Cancelling a job with savepoint is deprecated. Use "stop" instead.
Cancelling job fddb2c9db9040d2d8cc71100482fcd90 with CANONICAL savepoint to file:///opt/homebrew/Cellar/apache-flink/1.19.1/libexec/save/ts/tt.
Cancelled job fddb2c9db9040d2d8cc71100482fcd90. Savepoint stored in file:/opt/homebrew/Cellar/apache-flink/1.19.1/libexec/save/ts/tt/savepoint-fddb2c-e20d4f8b8434.
```



`flink run -m localhost:8081 -s file:///Users/chengxingfu/code/my/flink_learn/sgg/FlinkTutorial/chk/ab45538ce421f65d20e7af70df7c31c9/chk-8 -c com.atguigu.demo.chapter09.KeyedStateTest target/FlinkTutorial-1.0-SNAPSHOT-jar-with-dependencies.jar `

[参考](https://blog.csdn.net/zhuzuwei/article/details/107240708)这里chk 目录下应该会有其他文件，-s 也应该指定到chk 目录。[这里](https://readmedium.com/flink-checkpointing-and-recovery-7e59e76c2d45)也提到需要指定最后一个chk 目录，另外， Source 和Sink 的状态是保存到Job 级别，KeyedProcessFunction 保存每个key 的状态，open 函数要先读取

```scala
  override def open(parameters: Configuration): Unit = {
    state = getRuntimeContext.getState(new ValueStateDescriptor[CountWithTimestamp]("count-brew-state", classOf[CountWithTimestamp]))
    if (state == null) {
      LOG.info("Restored state is null")
      return
    }
  }
```

发现通过命令行无法触发状态恢复，但是通过UI 提交job 是可以触发状态恢复的(从UI Latest Restore 可以发现)。最后找到原因是-s 参数写到了jar 包后面，写到jar 前面就可以了。



防止检查点被自动清理,代码中加上这一行

```scala
  env.getCheckpointConfig.enableExternalizedCheckpoints(
      CheckpointConfig.ExternalizedCheckpointCleanup.RETAIN_ON_CANCELLATION
    );
```





状态恢复测试，发现会基于之前的统计继续累加：

`flink run -s  file:///opt/homebrew/Cellar/apache-flink/1.19.1/libexec/save/ts/48bb2fcbf0ac3963a24f0656887e07e6/chk-22 -c com.atguigu.demo.chapter02.StreamWordCount target/FlinkTutorial-1.0-SNAPSHOT-jar-with-dependencies.jar --host localhost --port 7777`





## 状态恢复现象

从UI 上提交Job，指定savepoint 的路径`file:/Users/chengxingfu/code/my/flink_learn/sgg/FlinkTutorial/chk/ab45538ce421f65d20e7af70df7c31c9/chk-8`

### taskManager 日志：

> 2025-08-14 15:25:05,963 INFO  org.apache.flink.runtime.state.heap.HeapRestoreOperation     [] - Starting to restore from state handle: KeyGroupsStateHandle{groupRangeOffsets=KeyGroupRangeOffsets{keyGroupRange=KeyGroupRange{startKeyGroup=0, endKeyGroup=127}}, stateHandle=ByteStreamStateHandle{handleName='file:/Users/chengxingfu/code/my/flink_learn/sgg/FlinkTutorial/chk/ab45538ce421f65d20e7af70df7c31c9/chk-8/e255a8ca-aebe-4311-93d2-c5830b47e707', dataBytes=9710}}.
>
> 2025-08-14 15:25:05,974 INFO  org.apache.flink.runtime.state.heap.HeapRestoreOperation     [] - Finished restoring from state handle: KeyGroupsStateHandle{groupRangeOffsets=KeyGroupRangeOffsets{keyGroupRange=KeyGroupRange{startKeyGroup=0, endKeyGroup=127}}, stateHandle=ByteStreamStateHandle{handleName='file:/Users/chengxingfu/code/my/flink_learn/sgg/FlinkTutorial/chk/ab45538ce421f65d20e7af70df7c31c9/chk-8/e255a8ca-aebe-4311-93d2-c5830b47e707', dataBytes=9710}}.

### UI Latest Restore

Job Checkpoints 下的Overview 有一行Latest Restore 显示了从哪个checkpoint 恢复的





Flink 1.15+ 版本中检查点目录只有一个 `_metadata`文件：

- 这是 Flink 的**设计优化**，不是错误
- 提供更好的性能和更简单的管理
- 恢复时只需指定包含 `_metadata`的目录
- 兼容性和可靠性都有所提高

# flink 命令

flink --help
./flink <ACTION> [OPTIONS] [ARGUMENTS]

## run

  Syntax: run [OPTIONS] <jar-file> <arguments>

❗️<font color=red>注意选项写到jar 文件前面，例如-s 如果写到jar 后面会导致无法恢复状态。</font>

  "run" action options:
     -c,--class <classname>           
     -C,--classpath <url>             
     -d,--detached       加该参数，即使Ctrl+C 也不会取消作业，默认不指定则为客户端模式，走集群则要加上--detached      
     **-n**,--allowNonRestoredState  允许跳过无法恢复的保存点状态 
     **-p**,--parallelism <parallelism>    **并行度**         
     -rm,--restoreMode <arg>     如何从指定savepoint 恢复claim/no_claim    
     **-s**,--fromSavepoint <savepointPath>   从保存点启动      
     -sae,--shutdownOnAttachedExit            
 📌 Options for Generic CLI mode:
     -D <property=value>   通用配置
     -t,--target <arg>     The deployment target for the given application,
                           which is equivalent to the "execution.target" config
                           option. For the "run" action the currently available
                           targets are: "remote", "local", "kubernetes-session",
                           "yarn-per-job" (deprecated), "yarn-session". For the
                           "run-application" action the currently available
                           targets are: "kubernetes-application".

  📌Options for yarn-cluster mode:
     -m,--jobmanager <arg>            Set to yarn-cluster to use YARN execution mode.
     -yid,--yarnapplicationId <arg>   Attach to running YARN session
     -z,--zookeeperNamespace <arg>    Namespace to create the Zookeeper sub-paths for high availability mode

  📌Options for default mode:
     -D <property=value>            
     -m,--jobmanager <arg>           Address of the JobManager to which to
                                     connect. Use this flag to connect to a
                                     different JobManager than the one specified
                                     in the configuration. Attention: This
                                     option is respected only if the
                                     high-availability configuration is NONE.
     -z,--zookeeperNamespace <arg>   Namespace to create the Zookeeper sub-paths
                                     for high availability mode



## run-application

Action "run-application" runs an application in Application Mode.

  Syntax: run-application [OPTIONS] <jar-file> <arguments>
  Options for Generic CLI mode:
     -D <property=value>  
     -t,--target <arg>     The deployment target for the given application,
                           which is equivalent to the "execution.target" config
                           option. For the "run" action the currently available
                           targets are: "remote", "local", "kubernetes-session",
                           "yarn-per-job" (deprecated), "yarn-session". For the
                           "run-application" action the currently available
                           targets are: "kubernetes-application".

## info

**显示优化后的执行计划**

Action "info" shows the optimized execution plan of the program (JSON).

  Syntax: info [OPTIONS] <jar-file> <arguments>
  "info" action options:
     -c,--class <classname>           Class with the program entry point
                                      ("main()" method). Only needed if the JAR
                                      file does not specify the class in its
                                      manifest.
     -p,--parallelism <parallelism>   The parallelism with which to run the
                                      program. Optional flag to override the
                                      default value specified in the
                                      configuration.

## list

Action "list" lists running and scheduled programs.

  Syntax: list [OPTIONS]
  "list" action options:
     -a,--all         Show all programs and their JobIDs
     -r,--running     Show only running programs and their JobIDs
     -s,--scheduled   Show only scheduled programs and their JobIDs
  Options for Generic CLI mode:
     -D <property=value>   Allows specifying multiple generic configuration
                           options. The available options can be found at
                           https://nightlies.apache.org/flink/flink-docs-stable/
                           ops/config.html
     -e,--executor <arg>   DEPRECATED: Please use the -t option instead which is
                           also available with the "Application Mode".
                           The name of the executor to be used for executing the
                           given job, which is equivalent to the
                           "execution.target" config option. The currently
                           available executors are: "remote", "local",
                           "kubernetes-session", "yarn-per-job" (deprecated),
                           "yarn-session".
     -t,--target <arg>     The deployment target for the given application,
                           which is equivalent to the "execution.target" config
                           option. For the "run" action the currently available
                           targets are: "remote", "local", "kubernetes-session",
                           "yarn-per-job" (deprecated), "yarn-session". For the
                           "run-application" action the currently available
                           targets are: "kubernetes-application".

  Options for yarn-cluster mode:
     -m,--jobmanager <arg>            Set to yarn-cluster to use YARN execution
                                      mode.
     -yid,--yarnapplicationId <arg>   Attach to running YARN session
     -z,--zookeeperNamespace <arg>    Namespace to create the Zookeeper
                                      sub-paths for high availability mode

  Options for default mode:
     -D <property=value>             Allows specifying multiple generic
                                     configuration options. The available
                                     options can be found at
                                     https://nightlies.apache.org/flink/flink-do
                                     cs-stable/ops/config.html
     -m,--jobmanager <arg>           Address of the JobManager to which to
                                     connect. Use this flag to connect to a
                                     different JobManager than the one specified
                                     in the configuration. Attention: This
                                     option is respected only if the
                                     high-availability configuration is NONE.
     -z,--zookeeperNamespace <arg>   Namespace to create the Zookeeper sub-paths
                                     for high availability mode

## stop

Action "stop" stops a running program with a savepoint (streaming jobs only).

  Syntax: stop [OPTIONS] <Job ID>
  "stop" action options:
     **-d**,--drain                           Send MAX_WATERMARK before taking the savepoint and stopping the pipelne.
     -detached                            Triggering savepoint in detached mode,
                                          client and JM are decoupled, return
                                          the savepoint trigger id as the unique
                                          identification of the detached
                                          savepoint.
     **-p**,--savepointPath <savepointPath>   设置自定义的savepoints 路径  ("state.savepoints.dir").
     -type,--type <arg>                   Describes the binary format in which a
                                          savepoint should be taken. Supported
                                          options: [canonical - a common format
                                          for all state backends, allow for
                                          changing state backends, native = a
                                          specific format for the chosen state
                                          backend, might be faster to take and
                                          restore from.
  Options for Generic CLI mode:
     -D <property=value>   Allows specifying multiple generic configuration
                           options. The available options can be found at
                           https://nightlies.apache.org/flink/flink-docs-stable/
                           ops/config.html
     -e,--executor <arg>   DEPRECATED: Please use the -t option instead which is
                           also available with the "Application Mode".
                           The name of the executor to be used for executing the
                           given job, which is equivalent to the
                           "execution.target" config option. The currently
                           available executors are: "remote", "local",
                           "kubernetes-session", "yarn-per-job" (deprecated),
                           "yarn-session".
     -t,--target <arg>     The deployment target for the given application,
                           which is equivalent to the "execution.target" config
                           option. For the "run" action the currently available
                           targets are: "remote", "local", "kubernetes-session",
                           "yarn-per-job" (deprecated), "yarn-session". For the
                           "run-application" action the currently available
                           targets are: "kubernetes-application".

  Options for yarn-cluster mode:
     -m,--jobmanager <arg>            Set to yarn-cluster to use YARN execution
                                      mode.
     -yid,--yarnapplicationId <arg>   Attach to running YARN session
     -z,--zookeeperNamespace <arg>    Namespace to create the Zookeeper
                                      sub-paths for high availability mode

  Options for default mode:
     -D <property=value>             Allows specifying multiple generic
                                     configuration options. The available
                                     options can be found at
                                     https://nightlies.apache.org/flink/flink-do
                                     cs-stable/ops/config.html
     -m,--jobmanager <arg>           Address of the JobManager to which to
                                     connect. Use this flag to connect to a
                                     different JobManager than the one specified
                                     in the configuration. Attention: This
                                     option is respected only if the
                                     high-availability configuration is NONE.
     -z,--zookeeperNamespace <arg>   Namespace to create the Zookeeper sub-paths
                                     for high availability mode



`flink run -m localhost:8081 -c com.atguigu.demo.chapter02.StreamWordCount target/FlinkTutorial-1.0-SNAPSHOT-jar-with-dependencies.jar --host localhost --port 7777  -d`

`flink stop -p 6296a 6296a68a88842204ebbf92ff80209ebd`
Suspending job "6296a68a88842204ebbf92ff80209ebd" with a CANONICAL savepoint.
Triggering stop-with-savepoint for job 6296a68a88842204ebbf92ff80209ebd.
Waiting for response...

 The program finished with the following exception:

org.apache.flink.util.FlinkException: Could not stop with a savepoint job "6296a68a88842204ebbf92ff80209ebd".

**`flink stop`的工作机制**：

- 该命令会**优雅停止**作业：先停止 Source 接收新数据，但会继续处理已接收的数据直到完成
- 对于 `socketTextStream`，停止 Source 意味着**关闭 Socket 连接**, 导致作业失败。

请使用cancel

## cancel

Action "cancel" cancels a running program.

  Syntax: cancel [OPTIONS] <Job ID>
  "cancel" action options:
     -s,--withSavepoint <targetDirectory>   **DEPRECATION WARNING**: Cancelling
                                            a job with savepoint is deprecated.
                                            Use "stop" instead.
                                            Trigger savepoint and cancel job.
                                            The target directory is optional. If
                                            no directory is specified, the
                                            configured default directory
                                            (state.savepoints.dir) is used.
  Options for Generic CLI mode:
     -D <property=value>   Allows specifying multiple generic configuration
                           options. The available options can be found at
                           https://nightlies.apache.org/flink/flink-docs-stable/
                           ops/config.html
     -e,--executor <arg>   DEPRECATED: Please use the -t option instead which is
                           also available with the "Application Mode".
                           The name of the executor to be used for executing the
                           given job, which is equivalent to the
                           "execution.target" config option. The currently
                           available executors are: "remote", "local",
                           "kubernetes-session", "yarn-per-job" (deprecated),
                           "yarn-session".
     -t,--target <arg>     The deployment target for the given application,
                           which is equivalent to the "execution.target" config
                           option. For the "run" action the currently available
                           targets are: "remote", "local", "kubernetes-session",
                           "yarn-per-job" (deprecated), "yarn-session". For the
                           "run-application" action the currently available
                           targets are: "kubernetes-application".

  Options for yarn-cluster mode:
     -m,--jobmanager <arg>            Set to yarn-cluster to use YARN execution
                                      mode.
     -yid,--yarnapplicationId <arg>   Attach to running YARN session
     -z,--zookeeperNamespace <arg>    Namespace to create the Zookeeper
                                      sub-paths for high availability mode

  Options for default mode:
     -D <property=value>             Allows specifying multiple generic
                                     configuration options. The available
                                     options can be found at
                                     https://nightlies.apache.org/flink/flink-do
                                     cs-stable/ops/config.html
     -m,--jobmanager <arg>           Address of the JobManager to which to
                                     connect. Use this flag to connect to a
                                     different JobManager than the one specified
                                     in the configuration. Attention: This
                                     option is respected only if the
                                     high-availability configuration is NONE.
     -z,--zookeeperNamespace <arg>   Namespace to create the Zookeeper sub-paths
                                     for high availability mode



`flink cancel -s ${Path} eddb6a5b37b97ea928ab14ffbff5c50e`

## savepoint

**对运行过程中的job 触发savepoint**

Action "savepoint" triggers savepoints for a running job or disposes existing ones.

  Syntax: savepoint [OPTIONS] <Job ID> [<target directory>]
  "savepoint" action options:
     -d,--dispose <arg>       指定要删除的保存点的路径。
     -detached                Triggering savepoint in detached mode, client and
                              JM are decoupled, return the savepoint trigger id
                              as the unique identification of the detached
                              savepoint.
     -j,--jarfile <jarfile>   Flink program JAR file.
     -type,--type <arg>       Describes the binary format in which a savepoint
                              should be taken. Supported options: [canonical - a
                              common format for all state backends, allow for
                              changing state backends, native = a specific
                              format for the chosen state backend, might be
                              faster to take and restore from.
  Options for Generic CLI mode:
     -D <property=value>   

​     -t,--target <arg>     The deployment target for the given application,
​                           which is equivalent to the "execution.target" config
​                           option. For the "run" action the currently available
​                           targets are: "remote", "local", "kubernetes-session",
​                           "yarn-per-job" (deprecated), "yarn-session". For the
​                           "run-application" action the currently available
​                           targets are: "kubernetes-application".

  Options for yarn-cluster mode:
     -m,--jobmanager <arg>            Set to yarn-cluster to use YARN execution
                                      mode.
     -yid,--yarnapplicationId <arg>   Attach to running YARN session
     -z,--zookeeperNamespace <arg>    Namespace to create the Zookeeper
                                      sub-paths for high availability mode

  Options for default mode:
     -D <property=value>             Allows specifying multiple generic
                                     configuration options. The available
                                     options can be found at
                                     https://nightlies.apache.org/flink/flink-do
                                     cs-stable/ops/config.html
     -m,--jobmanager <arg>           Address of the JobManager to which to
                                     connect. Use this flag to connect to a
                                     different JobManager than the one specified
                                     in the configuration. Attention: This
                                     option is respected only if the
                                     high-availability configuration is NONE.
     -z,--zookeeperNamespace <arg>   Namespace to create the Zookeeper sub-paths
                                     for high availability mode





`flink savepoint b18b16363b317ab36f5e55f42ddc366b /opt/homebrew/Cellar/apache-flink/1.19.1/libexec/save/b18b16`



## checkpoint

Action "checkpoint" triggers checkpoints for a running job.

  Syntax: checkpoint [OPTIONS] <Job ID>
  "checkpoint" action options:
     **-full,**--full   Defines whether to trigger this checkpoint as a full one.
  Options for Generic CLI mode:
     -D <property=value>
     -t,--target <arg>     The deployment target for the given application,
                           which is equivalent to the "execution.target" config
                           option. For the "run" action the currently available
                           targets are: "remote", "local", "kubernetes-session",
                           "yarn-per-job" (deprecated), "yarn-session". For the
                           "run-application" action the currently available
                           targets are: "kubernetes-application".

  Options for yarn-cluster mode:
     -m,--jobmanager <arg>            Set to yarn-cluster to use YARN execution
                                      mode.
     -yid,--yarnapplicationId <arg>   Attach to running YARN session
     -z,--zookeeperNamespace <arg>    Namespace to create the Zookeeper
                                      sub-paths for high availability mode

  Options for default mode:
     -D <property=value>             Allows specifying multiple generic
                                     configuration options. The available
                                     options can be found at
                                     https://nightlies.apache.org/flink/flink-do
                                     cs-stable/ops/config.html
     -m,--jobmanager <arg>           Address of the JobManager to which to
                                     connect. Use this flag to connect to a
                                     different JobManager than the one specified
                                     in the configuration. Attention: This
                                     option is respected only if the
                                     high-availability configuration is NONE.
     -z,--zookeeperNamespace <arg>   Namespace to create the Zookeeper sub-paths
                                     for high availability mode



# tips

[配置本地UI](https://blog.csdn.net/weixin_47298890/article/details/122693931)

配置完后，运行报错：scala: No 'scala-library*.jar' in Scala compiler classpath in Scala SDK Maven: scala-sdk-2.12

[参考这个](https://blog.csdn.net/hyj_king/article/details/104501887)解决

