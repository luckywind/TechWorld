参考<尚硅谷大数据项目之电商数仓>

[数据仓库系列](https://blog.csdn.net/weixin_39032019/article/details/116303347)

# 数仓理论



## 关系建模与维度建模

关系模型符合三范式，数据冗余程度低，数据分布在众多表中，这些数据可以更为灵活的被使用，功能性较强。主要用于OLTP系统中。关系模型冗余少，但是在大规模数据，跨表分析时，会造成多表关联，大大降低执行效率。

维度模型，主要用在OLAP系统中，通常以某一个事实表为中心进行表的组织，事实表的每个主键对应一个维度表， 主要面向业务，特征可能存在冗余，但是方便获取数据。

> 事件对应到各个维度表的主键加上度量值事实字段构成一个事实表的记录

### 维度建模

在维度建模的基础上，又分为三种模型，星形模型、雪花模型、星座模型。

1. 最简单的是星型模型，标准的维度层级只有一层；

2. 雪花模型的维度层级可以有多层，比较靠近3范式；维度表上又关联了其他维度表。

3. 星座模型可以有多个事实表，多个事实表共享维度表，基本上是很多数仓的常态，因为很多数据仓库都是多个事实表的，所以星座不星座只反映是否有多个事实表，他们之间是否共享一些维度表，这个只根数据和需求有关系，跟设计没关系。

我们倾向于星型模型和雪花模型并存，灵活组合 ，但更倾向于星型模型，因为Hadoop体系减少Join就是减少Shuffle。

维度建模四部曲： **选择业务处理过程** **>** **定义粒度** **>** **选择维度** **>** **确定事实**

### 范式建模

即实体关系（ER）模型，数据仓库之父Immon提出的，从全企业的高度设计一个3NF模型，用实体加关系描述的数据模型描述企业业务架构，在范式理论上符合3NF。此建模方法，对建模人员的能力要求非常高。

特点：设计思路自上而下，适合上游基础数据存储，同一份数据只存储一份，没有数据冗余，方便解耦，易维护，缺点是开发周期一般比较长，维护成本高。

## 维度表和事实表

### 维度表：

 一般是对事实的描述信息，每一张维表对应现实世界中的一个对象或者概念。

主要关注下退化维度和缓慢变化维

#### 退化维度

这种维度指的是直接把一些简单的维度放在事实表中。退化维度是维度建模领域中的一个非常重要的概念，它对理解维度建模有着非常重要的作用，退化维度一般在分析中可以用来做分组使用。

#### 缓慢变化维（Slowly Changing Dimensions）

维度的属性并不是始终不变的，它会随着时间的流逝发生缓慢的变化，这种随时间发生变化的维度我们一般称之为缓慢变化维（SCD）。

SCD常用的三种处理方式：

1. 直接覆盖原值

<img src="https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image-20221202234254293.png" alt="image-20221202234254293" style="zoom:50%;" />

2. 增加维度行

*在为维度成员增加新行时，需为其<font color=red>分配新的主代理键</font>。**并且，至少需要在维度行再增加三列：**<font color=red>有效日期、截止日期、行状态</font>。**这个地方可联想拉链表设计。*

<img src="https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image-20221202234318336.png" alt="image-20221202234318336" style="zoom:50%;" />

3. 增加属性列

![image-20210521214635103](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20210521214635103.png)

4. 混合方式

可根据实际业务场景，混合或选择使用以上三种方式，以快速方便而又准确的分析历史变化情况。



### 事实表：

事实表中的每行数据代表一个业务事件(下单、支付、退款、评价等)。“事实”这个术语表示的是业务事件的**度量值**(可统计次数、个数、件数、金额等)。

1. <font color=red>**事务型事实表**</font>：  以每个事务或事件为单位，例如一个销售订单记录，一笔支付记录等。事实表数据一旦插入，就不再进行更改，其更新方式为增量更新。
2. <font color=red>**周期型快照事实表**</font>：周期型快照事实表中不会保留所有数据，**只保留固定时间间隔的数据**，例如每天或者每月的销售额，或每月的账号余额等。
3. <font color=red>**累计型快照事实表**</font>： 累计快照事实表用于**跟踪业务事实的变化**。例如，数据仓库中可能需要累积或者存储订单从下订单开始，到订单商品被打包、运输、和签收的各个业务阶段的时间点数据来跟踪订单生命周期的进展情况。当这个业务过程进行时，事实表的记录也要不断更新。

#### 事实表设计八大原则

- 原则 1：**尽可能包含所有与业务过程相关的事实**
  分析哪些事实与业务过程相关，是设计过程中非常重要的关注点；
  在事实表中，尽量包含所有与业务过程相关的事实，即使存在冗余，由于事实通常是数字型，存储开销不会太大；

- 原则 2：**只选择与业务过程相关的事实**
  如，订单的下单这个业务过程，事实表中不应该存在支付金额这个表示支付业务过程的事实；

- 原则 3：**分解不可加性事实为可加的组件**
  如，订单的优惠率，应分解为订单原价金额与订单优惠金额两个事实存储在事实表中；

- 原则 4：在选择维度和事实之前必须**先声明粒度**
  因为原子粒度提供了最大限度的灵活性，可以支持无法预期的各种细节层次的用户需求；
  粒度用于确定事实表中一行所表示业务的细节层次，决定了维度模型的扩展性；
  每个维度和事实必须与所定义的粒度保持一致；
  设计事实表时，粒度定义越细越好，一般从最低级别的原子粒度开始；

- 原则 5：**在同一个事实表中不能有多种不同粒度的事实**
  粒度为票一级；（实际业务中，一个订单可以同时支付多张票）
  票支付金额和票折扣金额，两个事实的粒度为 “票级”，与定义的粒度一致；订单支付金额和订单票数，两个事实的粒度为 “订单级”，属于上一层订单级数据，与“票级” 事实表的粒度不一致，且不能进行汇总；如果，以订单金额和订单票数这两个维度汇总总金额和总票数，会造成大量的重复计算；
  疑问：怎么判断不同事实的粒度是否相同？

- 原则 6：**事实的单位要保持一致**
  如，订单金额、订单优惠金额、订单运费这 3 个事实，应该采用统一的计量单位，统一为元或者分，以方便使用；

- 原则 7：**对事实的 null 值要处理**
  原因：在数据库中，null 值对常用数字型字段的 SQL 过滤条件都不生效；如，大于、小于、等于、大于或等于、小于或等于；
  处理：用 0 代替 null ；

- 原则 8：**使用退化维度提高事实表的易用性**
  易用性：对事实表，更较少关联操作、过滤查询、控制聚合层次、排序数据、定义主从关系等；
  事实表中存储各种类型的常用维度信息，较少下游用户使用时关联多个表的操作；
  通过退化维度，可以实现对事实表的过滤查询、控制聚合层次、排序数据、定义主从关系等；
  在 Kimball 的维度建模中，通常按照星形模型的方式设计，通过事实表的外键关联专门的维表，这种方式来获取维度，谨慎使用退化维表；这与大数据领域的事实表设计不一样；
  思路：通过增加冗余存储，减少计算开销，提高使用效率；



### 粒度

用于确定某一事实表中的行表示什么，是业务最小活动单元或不同维度组合，即业务细节程度。

## 维度建模流程

维度建模步骤：选择业务过程->声明粒度->确定维度->确定事实。旨在重点解决数据粒度、维度设计和事实表设计问题。

![图片](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/640.jpeg)

- <font color=red>选择业务过程</font>

  > 紧贴业务，根据需求和扩展性在整个流程中选择业务。 例如商城流程分为商家端、用户端、平台端，如果需求是订单量、订单人数、用户购买情况等，则应该选择用户端。

  - 单业务过程选择单事务事实表，多业务过程选择累积快照事实表
  - 明确关键的业务步骤，选择与需求有关的业务过程

- <font color=red>声明粒度</font>

  > 例如，对用户来说，一个用户有一个身份证号、一个户籍地址、多个手机号和多张银行卡，与用户粒度相同的粒度属性有身份证粒度，户籍地址粒度；即一对一关系的是相同粒度。

  - 尽量选择最细级别的原子粒度，以确保事实表的应用具有最大的灵活性
  - 同一个事实表中，必须具有相同的粒度

- <font color=red>确定维度</font>

  - 维度表是作为业务分析的入口和描述性标识，所以也被称为数据仓库的“灵魂”
  - 完成了粒度声明就意味着确定了主键，对应的维度组合以及相关的维度字段也可以确定了,如果该列是对具体值的描述，是一个文本或常量，**某一约束和行标识的参与者**，此时该属性往往是维度属性
  - 选择维度的原则： 选择能够描述清楚业务过程所处环境的维度信息
  - 牢牢掌握事实表的粒度，就能将所有可能存在的维度区分开，并且要确保维度表中不能出现重复数据，应使维度主键唯一

- <font color=red>确认事实</font>

  > 最实用的事实就是数值类型和可加类事实。所以可以通过分析该列是否是一种包含多个值并作为计算的参与者的度量，这种情况下该列往往是事实。

  - 选择与业务过程有关的所有事实，且事实的粒度要与所声明的事实表的粒度一致（思路：回答“过程的度量是什么”来确定）
  - 将不可加性事实分解为可加的组件

## 多维体系结构

在Kimball的维度建模的数据仓库中，关于多维体系结构（MD）有三个关键性概念：

1. **总线架构（Bus Architecture）**
   业务过程和维度的交点；

   

   <img src="https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/8d8e9a23c2ed591c5fe59adfea3c9965.png" alt="https://mmbiz.qpic.cn/mmbiz_png/Jy3qP5tic4icSUZPphtibOGia8NhkDFBViaPQQk9flT8rs9Jhb2XAVBbHZPWMDsGYzA4swIJjlF2a4rqfGxMiciaM1xQw/640?wx_fmt=png" style="zoom:50%;" />

2. **一致性维度（Conformed Dimension）**
   <font color=red>同一集市的维度表，内容相同或包含；</font>

   <font color=red>在多维体系结构中，没有物理上的数据仓库，由物理上的数据集市组合成逻辑上的数据仓库</font>。而且数据集市的建立是可以逐步完成的，最终组合在一起，成为一个数据仓库。<font color=red>如果分步建立数据集市的过程出现了问题，数据集市就会变成孤立的集市，不能组合成数据仓库，而一致性维度的提出正是为了解决这个问题。</font>

3. **一致性事实（Conformed Fact）** 

不同集市的同一事实，需保证**口径一致，单位**统一。<font color=red>一致性维度将多个数据集市结合在一起，一致性事实保证不同数据集市间的事实数据可以交叉探查</font>，一个分布式的数据仓库就建成了。



## 数仓建模

### 为什么要分层

![image-20240905083135977](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image-20240905083135977.png)

1. <u>复杂问题简单化</u>，将复杂的任务分解成多层来完成，每一层只处理简单的任务，方便定位问题
2. <u>减少重复开发</u>，规范数据分层，通过中间层数据，能够减少极大的重复计算，增加计算结果的复用性 
3. <u>隔离原始数据</u>，不论是数据的异常还是数据的敏感性， 使真实数据与统计数据解藕开

### 数据集市vs数据仓库

- 数据集市是一种微型的数据仓库，更少的主题域、更少的历史数据，是部门级的

- 数据仓库是企业级的，能为整个企业各部门的运行提供决策支持手段

### 三范式

1. 属性不可切割
2. 不存在部分函数依赖
3. 不存在传递函数依赖

### dwd层

<font color=red>dwd层需构建维度模型，一般采用星型模型，呈现的状态一般为星座模型。</font>

步骤：选择业务过程->声明粒度->确认维度->确认事实

1. 选择**业务过程**： 一条业务线对应一张事实表
2. **声明粒度**：数据粒度指数据仓库的数据中保存数据的<u>细化程度或综合程度的级别</u>。尽可能选择最小粒度，以此来应对各种各样的需求。
3. **确定维度**： 维度的主要作用是描述业务事实，主要表示的是"谁、何处、何时"等信息
4. **确定事实**：指度量值

dwd层，以业务过程为建模驱动，基于每个具体业务过程的特点，构建最细粒度的明细层事实表，可做适当的宽表化处理。

**至此，数仓的维度建模已经完毕，dws、dwt和ADS与维度建模已经没有关系了**，dws\dwt都是建宽表，宽表都是按照主题去建，主题相当于观察问题的角度，对应着维表。

### dws层

统计各个主题对象的<font color=red>**当天行为**</font>，服务于dwt层的主题宽表，以及一些业务明细数据，对应特殊需求(例如，购买行为，统计商品复购率)。

### dwt层

以分析的主题对象为建模驱动，基于上层的应用和产品的指标需求，构建主题对象的全量宽表。

例如： 会员主题、商品主题、活动主题、优惠券主题等。

### ads层

对电商系统各大主题指标分别进行分析。

# 数仓搭建

## ods层

1)保持数据原貌不做任何修改，起到备份数据的作用。

2)数据采用 LZO 压缩，减少磁盘存储空间。100G 数据可以压缩到 10G 以内。

3)创建分区表，防止后续的全表扫描，在企业开发中大量使用分区表。

4)创建外部表。在企业开发中，除了自己用的临时表，创建内部表外，绝大多数场景 都是创建外部表。

## dwd层

主要是对ods层数据清洗、整合得到的事实表或者维度表。这里就要考虑维度建模的设计了。注意事实表分三种，见1.2节。

缓慢变化维： 变动不频繁的维度表，这种表适合使用拉链表。 

## dws

dws层的宽表字段，是站在不同维度的视角去看事实表，重点关注事实表的度量值。以dwd为基础，按天进行轻度汇总。

## dwt层

以dws为基础，按主题进行汇总

宽表字段怎么来?维度关联的事实表度量值+开头、结尾+累积+累积一个时间段。

```sql
create external table dwt_user_topic
(
user_id string comment '用户 id', 
  login_date_first string comment '首次登录时间', 
  login_date_last string comment '末次登录时间',
login_count bigint comment '累积登录天数', 
  login_last_30d_count bigint comment '最近30日登录天数',
order_date_first string comment '首次下单时间', 
  order_date_last string comment '末次下单时间',
order_count bigint comment '累积下单次数', 
  order_amount decimal(16,2) comment '累积下单金额',
order_last_30d_count bigint comment '最近30日下单次数', 
  order_last_30d_amount bigint comment '最近30日下单金额',
payment_date_first string comment '首次支付时间', 
  payment_date_last string comment '末次支付时间', 
  payment_count decimal(16,2) comment '累积支付次数',
payment_amount decimal(16,2) comment '累积支付金额', 
  payment_last_30d_count decimal(16,2) comment '最近30日支付次数',
payment_last_30d_amount decimal(16,2) comment '最近30日支付金额' )COMMENT '用户主题宽表'
```



设备主题宽表

会员主题宽表

商品主题宽表

## ads层

各种主题表，注意不是主题宽表



