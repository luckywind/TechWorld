参考<尚硅谷大数据项目之电商数仓>

# 数仓理论

![image-20210509231039967](../../../../../Library/Application Support/typora-user-images/image-20210509231039967.png)

## 关系建模与维度建模

关系模型符合三范式，数据冗余程度低，数据分布在众多表中，这些数据可以更为灵活的被使用，功能性较强。主要用于OLTP系统中。关系模型冗余少，但是在大规模数据，跨表分析时，会造成多表关联，大大降低执行效率。

维度模型，主要用在OLAP系统中，通常以某一个事实表为中心进行表的组织，事实表的每个主键对应一个维度表， 主要面向业务，特征可能存在冗余，但是方便获取数据。

> 事件对应到各个维度表的主键加上度量值事实字段构成一个事实表的记录

### 维度建模

在维度建模的基础上，又分为三种模型，星形模型、雪花模型、星座模型。

最简单的事星型模型，标准的维度层级只有一层；

雪花模型的维度层级可以有多层，比较靠近3范式；

星座模型可以有多个事实表，基本上是很多数仓的常态，因为很多数据仓库都是多个事实表的，所以星座不星座只反映是否有多个事实表，他们之间是否共享一些维度表，这个只根数据和需求有关系，跟设计没关系。

我们倾向于星型模型和雪花模型并存，灵活组合 ，但更倾向于星型模型，因为Hadoop体系减少Join就是减少Shuffle。

## 维度表和事实表

### 维度表：

 一般是对事实的描述信息，每一张维表对应现实世界中的一个对象或者概念。

主要关注下退化维度和缓慢变化维

#### 退化维度

这种维度指的是直接把一些简单的维度放在事实表中。退化维度是维度建模领域中的一个非常重要的概念，它对理解维度建模有着非常重要的作用，退化维度一般在分析中可以用来做分组使用。

#### 缓慢变化维（Slowly Changing Dimensions）

维度的属性并不是始终不变的，它会随着时间的流逝发生缓慢的变化，这种随时间发生变化的维度我们一般称之为缓慢变化维（SCD）。

SCD常用的三种处理方式：

1. 直接覆盖原值

![图片](https://mmbiz.qpic.cn/mmbiz_png/1OYP1AZw0W1UwPYvStthXYOIVIJMRPHgR0hXEic2ooibCQcliandOomZCkS90JesBrE3XfK9FT0L4mzloqeiaBLGiaQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

2. 增加维度行

*在为维度成员增加新行时，需为其分配新的主代理键。**并且，至少需要在维度行再增加三列：**有效日期、截止日期、行标识。**这个地方可联想拉链表设计。*

![图片](https://mmbiz.qpic.cn/mmbiz_png/1OYP1AZw0W1UwPYvStthXYOIVIJMRPHgJQjR5Q6icbWznia9JUHr1DA4I6nNictPvXmgNayXhgcBcL96FOJGmY8kw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

3. 增加属性列

![image-20210521214635103](https://gitee.com/luckywind/PigGo/raw/master/image/image-20210521214635103.png)

4. 混合方式

可根据实际业务场景，混合或选择使用以上三种方式，以快速方便而又准确的分析历史变化情况。



### 事实表：

事实表中的每行数据代表一个业务事件(下单、支付、退款、评价等)。“事实”这个术语表示的是业务事件的度量值(可统计次数、个数、件数、金额等)。

1. **事务型事实表**：  以每个事务或事件为单位，例如一个销售订单记录，一笔支付记录等。事实表数据一旦插入，就不再进行更改，其更新方式为增量更新。
2. **周期型快照事实表**：周期型快照事实表中不会保留所有数据，**只保留固定时间间隔的数据**，例如每天或者每月的销售额，或每月的账号余额等。
3. **累计型快照事实表**： 累计快照事实表用于**跟踪业务事实的变化**。例如，数据仓库中可能需要累积或者存储订单从下订单开始，到订单商品被打包、运输、和签收的各个业务阶段的时间点数据来跟踪订单生命周期的进展情况。当这个业务过程进行时，事实表的记录也要不断更新。

## 粒度

用于确定某一事实表中的行表示什么，是业务最小活动单元或不同维度组合，即业务细节程度。

## 维度建模流程

维度建模步骤：选择业务过程->声明粒度->确定维度->确定事实。旨在重点解决数据粒度、维度设计和事实表设计问题。

![图片](https://gitee.com/luckywind/PigGo/raw/master/image/640.jpeg)

## 数仓建模

### dwd层

dwd层需构建维度模型，一般采用星型模型，呈现的状态一般为星座模型。

步骤：选择业务过程->声明粒度->确认维度->确认事实

1. 选择业务过程： 一条业务线对应一张事实表
2. 声明粒度：数据粒度指数据仓库的数据中保存数据的细化程度或综合程度的级别。尽可能选择最小粒度，以此来应对各种各种的需求。
3. 确定维度： 维度的主要作用是描述业务事实，主要表示的是"谁、何处、何时"等信息
4. 确定事实：指度量值

dwd层，以业务过程为建模驱动，基于每个具体业务过程的特点，构建最细粒度的明细层事实表，可做适当的宽表化处理。

**至此，数仓的维度建模已经完毕，dws、dwt和ADS与维度建模已经没有关系了**，dws\dwt都是建宽表，宽表都是按照主题去建，主题相当于观察问题的角度，对应着维表。

### dws层

统计各个主题对象的**当天行为**，服务于dwt层的主题宽表，以及一些业务明细数据，对应特殊需求(例如，购买行为，统计商品复购率)。

### dwt层

以分析的主题对象为建模驱动，基于上层的应用和产品的指标需求，构建主题对象的全量宽表。

例如： 会员主题、商品主题、活动主题、优惠券主题等。

### ads层

对电商系统各大主题指标分别进行分析。

# 数仓搭建

## ods层

1)保持数据原貌不做任何修改，起到备份数据的作用。

2)数据采用 LZO 压缩，减少磁盘存储空间。100G 数据可以压缩到 10G 以内。

3)创建分区表，防止后续的全表扫描，在企业开发中大量使用分区表。

4)创建外部表。在企业开发中，除了自己用的临时表，创建内部表外，绝大多数场景 都是创建外部表。

## dwd层

主要是对ods层数据清洗、整合得到的事实表或者维度表。这里就要考虑维度建模的设计了。注意事实表分三种，见1.2节。

缓慢变化维： 变动不频繁的维度表，这种表适合使用拉链表。 

## dws

dws层的宽表字段，是站在不同维度的视角去看事实表，重点关注事实表的度量值。以dwd为基础，按天进行轻度汇总。

## dwt层

以dws为基础，按主题进行汇总

宽表字段怎么来?维度关联的事实表度量值+开头、结尾+累积+累积一个时间段。

```sql
create external table dwt_user_topic
(
user_id string comment '用户 id', 
  login_date_first string comment '首次登录时间', 
  login_date_last string comment '末次登录时间',
login_count bigint comment '累积登录天数', 
  login_last_30d_count bigint comment '最近30日登录天数',
order_date_first string comment '首次下单时间', 
  order_date_last string comment '末次下单时间',
order_count bigint comment '累积下单次数', 
  order_amount decimal(16,2) comment '累积下单金额',
order_last_30d_count bigint comment '最近30日下单次数', 
  order_last_30d_amount bigint comment '最近30日下单金额',
payment_date_first string comment '首次支付时间', 
  payment_date_last string comment '末次支付时间', 
  payment_count decimal(16,2) comment '累积支付次数',
payment_amount decimal(16,2) comment '累积支付金额', 
  payment_last_30d_count decimal(16,2) comment '最近30日支付次数',
payment_last_30d_amount decimal(16,2) comment '最近30日支付金额' )COMMENT '用户主题宽表'
```



设备主题宽表

会员主题宽表

商品主题宽表

## ads层

各种主题表，注意不是主题宽表



