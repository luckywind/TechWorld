# 数据整合及管理体系

1. 业务板块

根据业务属性划分板块，板块之间的指标或业务重叠性较小。

2. 规范定义

一套数据规范命名体系，用在模型设计中

3. 模型设计

以维度建模理论为基础，基于维度建模总线架构，构建一致性的维度和事实(进行规范定义)。

## 规范定义

以维度建模作为理论基础，构建总线矩阵，划分和定义数据域、业务过程、维度、度量/原子指标、修饰类型、修饰词、时间周期、派生指标。

### 名词术语

![image-20200822173630020](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200822173630020.png)

1. 数据域

面向业务分析，将业务过程或者维度进行抽象的集合。业务过程可以概括为一个个不可拆分的行为事件，在业务过程之下，可以定义指标；维度是指度量的环境，如买家下单事件，买家是维度 。 为保障整个体系的生命力 ， 数据域是需要 抽象提炼，并且长期维护和更新的 ， 但不轻易变动。

2. 业务过程

指企业的业务活动事件，如下单、支付、退款都是业务过程。 请注意，业务过程 是一个不可拆分的行为事件 ， 通俗地讲 ，业务过程就是企业活动中的事件

3. 时间周期

用来明确数据统计的时间范用或者时间点，如最近 30天、自然周、截至当日等

4. 修饰类型

**是对修饰词的一种抽象划分 。 修饰类型从属于某个业务域**，如日志域的**访问终端类型**涵盖无线端、 PC 端等修饰词

5. 修饰词

指除了统计维度以外指标的业务场景限定抽象 。 **修饰词隶属于一种修饰类型，如 在日志域的访问终端类型下 ， 有修饰词 PC 端、无线端等**

6. 度量/原子指标

原子指标和度量含义相同，基于某一业务事件行为下的度量，是业务定义中不可 再拆分的指标，具有明确业务含义的名词 ，如支付金额

7. 维度

**维度是度量的环境，用来反映业务的一类属性 ， 这类属性的集合构成一个维度 ， 也可以称为实体对象**。 维度属于一个数据域，如地理维度(其中包挤罔家、地区、 省以及城市等级别的内容)、时间维度(其中包括年、季、月、周、日等级别的内容)

8. 维度属性

维度属性隶属于一个维度 ， 如地理维度里面的国家名称、国家 ID、省份名称等 都属于维度属性

9. 派生指标

派生指标=一个原子指标+多个修饰词(可选)+时间周期+粒度。 可以理解为对原子指标业务统计范围的圈定。 如原子指标: 支付金额，最近 1天海外买家支付金额则为 派生指标(最近1天为时间周期 ， 海外为修饰词 ， 买家作为维度，而不作为修饰词)

### 指标体系

#### 基本原则

1. 组成体系之间的关系

- 派生指标由原子指标、时间周期修饰词、若干其他修饰词组合得到

![image-20200822172742558](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200822172742558.png)



- 原子指标、修饰类型及修饰词，直接归属在业务过程下，其中修饰词继承修饰类型的数据域

- 派生指标可以选择多个修饰词，修饰词之间的关系为"或"或者"且"，由派生指标具体语义决定
- 派生指标唯一归属一个原子指标，继承原子指标的数据域，与修饰词的数据域无关

2. 命名约定

- 命名所用术语。指标命名尽量使用英文简写，其次是英文。太长也可以考虑汉语拼音首字母
- 业务过程。英文名：用英文或英文的缩写或者中文拼音简写
- 原子指标。英文名：动作+度量
- 修饰词。只有时间周期才会有英文名

![image-20200822174355477](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200822174355477.png)

- 派生指标。英文名：原子指标英文名+时间周期修饰词(3位,例如_1d)+序号(4位，例如_001);

#### 操作细则

派生指标可以分为三类：事务型指标、存量型指标和复合型指标。

- **事务型指标**： **是指对业务活动进行衡量的指标**。例如新发商品数、 重发商品数、新增注册会员数、订单支付金额，**这类指标需维护 原子指标及修饰词**，在此基础上创建派生指标。
- **存量型指标:是指对实体对象(如商品、会员)某些状态的统计**。 例如商品总数、注册会员总数，这类指标需维护原子指标及修饰 词，在此基础上创建派生指标，对应的时间周期 一般为“**历史截 至当前某个时间**”。
- **复合型指标:是在事务型指标和存量型指标的基础上复合而成 的**。例如浏览 UV-下单买家数转化率 ， 有些需要 创 建新原子指标， 有些则可以在事务型或存量型原子指标的基础上增加修饰词得 到派生指标。

## 模型设计

### 指导理论

数据模型的维度设计主要 以 **维度建模理论为基础，基于维度数据模型总线架构，构建 一致 性的维度 和事实。**

### 模型层次

**操作数据层( ODS)**:把操作系统数据几乎无处理地存放在数据仓 库系统中。

**公共维度模型层( CDM ):**存放明细事实数据、维表数据及公共指标汇总数据 ， 其中明细事实数据、维表数据一般根据 ODS 层数据加工 生成 ；公共指标汇总数据 一般根据维表数据和明细事实数据加工生成。

CDM 层又细分为 DWD 层和 DWS 层，分别是明细数据层和汇总数据层，采用维度模型方法作为理论基础 ， **更多 地采用 一 些维度退化手法， 将维度退化至事实表中，减少事实表和维表的关联 ，提高明细数据表的 易用性** :同时在汇总数据层， 加强指标的维度退化， 采取更多的宽表化手段构建公共指标数据层，提升公共指标的复用性，减少重复加工。

其 主要功 能如下。

- 组合相关和相似数据:采用明细宽表，复用关联计算，减少数据 扫描。

- 公共指标统一加工:基于 OneData体系构建命名规范、口径一致 和算法统一 的统计指标，为上层数据产品、应用和服务提供公共指标建立逻辑汇总宽表。

- 建立 一 致性维度:建立 一 致的数据分析维表，降低数据计算口径、 算法不统一的风险。

**应用数据层( ADS)**:存放数据产品个性化的统计指标数据，根据 CDM 层与 ODS 层加工生成 。

- 个性化指标加工:不公用性、复杂性(指数型、比值型、排名型

指标)。

- 基于应用的数据组装 : 大宽表集市、横表转纵表、趋势指标串。

<img src="https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/p44631.png" alt="数仓分层" style="zoom:50%;" />

阿里巴巴通过构建全域的公共层数据，极大地控制了数据规模的增长趋势

<img src="https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200829162536643.png" alt="image-20200829162536643" style="zoom:50%;" />

​																															模型架构图

**数据调用服务优先使用公共维度模型层( CDM )数据，当公共层没有数据时，需评估是否需要创建公共层数据，当不需要建设公用的公 共层时，方可直接使用操作数据层( ODS)数据。应用数据层( ADS) 作为产品特有的个性化数据一般不对外提供数据服务，但是 ADS 作为 被服务方也需要遵守这个约定。**

### 基本原则

1 . **高内聚和低辑合**

一个逻辑或者物理模型由哪些记录和字段组成，应该遵循最基本的软件设计方法论的高内聚和低藕合原则。主要从数据业务特性和访问特

性两个角度来考虑 :将业务相近或者相关、粒度相同的数据设计为一个逻辑或者物理模型:将高概率同时访问的数据放 一起 ，将低概率同时访 问的数据分开存储。

2. **核心模型与扩展模型分离**

建立核心模型与扩展模型体系，核心模型包括 的宇段支持常用的核 心业务，扩展模型包括的字段支持个性化或少量应用的需要 ，不能让扩 展模型的宇段过度侵人核心模型，以免破坏核心模型的架构简洁性与可 维护性。

3. **公共处理逻辑下沉及单一**

越是底层公用的处理逻辑越应该在数据调度依赖的底层进行封装 与实 现，不要让公用的处理逻辑暴露给应用层实现，不要让公共逻辑多 处同时存在。

4. **成本与性能平衡**

适当的数据冗余可换取查询和刷新性能，不宜过度冗余与数据复制。

5. **数据可回滚**

处理逻辑不变，在不同时间多次运行数据结果确定不变。

6. **一致性**

具有相同含义的字段在不同表中的命名必须相同，必须使用规范定

义中的名称。

7. **命名清晰、可理解**

表命名需清晰、一致，表名需易于消费者理解和使用。

## 模型实施

### 业界常用模型实施过程

构建维度模型一般要经历四个阶段:

1. 第一个阶段是高层设计时期 ， **定义业务过程维度模型的范围，提供每种星形模式的技术和功能描述;** 

直接产出目标是创建高层维度模型图，它是对业务过程中的维表和事实表的图形描述。确定维表创建初始属性列 表， 为每个事实表 创 建提议度量。

2. 第二个阶段是详细模型设计时期，**对每个星形模型添加属性和度量信 息**;

确定 每个 维表的属性和每个事实表的度量，并确定信息来源的位置、定义，确 定 属性和度量如何填人模型的初步业务规则。

3. 第三个阶段是进行模型的审查、再设计和验证等工作，

本阶段主要召集相关人员进行模型的审查和验证，根据审查结果对详细维度进行再设计。

4. 第四个阶段是产生详细设计文档，提交 ETL 设计和开发。

最后，完成模型详细设计文档，提交 ETL 开发人员，进入 ETL 设 计和开发阶段，由 ETL 人员完成物理模型的设计和开发。

### OneData实施过程

#### 指导方针

首先，在建设大数据数据仓库时，要进行充分的业务调研和需求分析。这是数据仓库建设的基石，业务调研和需求分析做得是否充分 直接 决定了数据仓库建设是否成功。

其次，**进行数据总体架构设计，主要是根据数据域对数据进行划分;按照维度建模理论，构建总线矩阵、抽象出业务过程和维度**。

再次，对报表需求进行抽象整理出相关指标体 系， 使用 OneData工具完成指标规范定义和模型设计。

最后，就是代码研发和运维

#### 实施工作流

<img src="https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200829211132995.png" alt="image-20200829211132995" style="zoom:50%;" />

（1）数据调研

- 业务调研

需要了解各个业务领域、业务线的业务有什么共同 点和不同点 ，以及各个业务线可以细分为哪几个业务模块，每个业务模块具 体的 业务流程又是怎样的。业务调研是否充分，将会直接决定数据仓库 建设是 否成功 。

- 需求调研

此刻要做的就是收集数据使用 者的需求，可以去找分析师、业务运营人员了解他们有什么数据诉求， 此时更多的就是报表需求。

（2）架构设计

1. 数据域划分

   数据域是指面向业务分析，将业务过程或者维度进行抽象的集合。 业务过程可以概括为 一 个个不可拆分的行为事件，如下单、支付、退款。

   

   ![image-20200822204031542](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200822204031542.png)

2. 构建总线矩阵

   在进行充分的业务调研和需求调研后，就要构建总线矩阵了。

需要 做两件事情 :**明确每个数据域下有哪些业务过程;业务过程与哪些维度相关，并定义每个数据域下的业务过程和维度**。

![image-20200822204123823](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200822204123823.png)

3. 规范定义

规范定义主要定义指标体系，包括原子指标、修饰词、时间周期和 派生指标。

4. 模型设计

模型设计主要包括维度及属性的规范定义，维表、明细事实表和汇 总事实表的模型设计。

详细过程参考后续章节

5. 总结

OneData 的实施过程是一个高度迭代和动态的过程， 一般采用螺旋 式实施方法。在总体架构设计完成之后，开始根据数据域进行迭代式模 型设计和评审。在架构设计、规范定义和模型设计等模型实施过程中， 都会引人评审机制，以确保模型实施过程的正确性。

# 维度设计

维度建模中，将度量称为“事实” ， 将环境描述为“维度”，维度是用于分析事实所需要的多样环境。例如， 在分析交易过程时，可以通过买家、卖家、商品和时间等维度描述交易 发生的环境。

维度所包含的表示维度的列，称为维度属性。维度属性是查询约束 条件、分组和报表标签生成的基本来源，是数据易用性的关键。

维度使用主键标识其唯一性，主键也是确保与之相连的任何事实表 之间存在引用完整性的基础。

## 维度的基本设计方法

1. 选择维度或新建维度
2. 确定主维表。 一般是ODS表，直接与业务系统同步
3. 确定相关维表。确定哪些表和主维表存在关联关系，并选择其中的某些表用于生成维度属性。
4. 确定维度属性。第一阶段从主维表中选择维度属性或生成新的维度属性；第二阶段是从相关维表中选择维度属性或生成新的 维度属性。

# 事实表设计

## 事实表基础

### 事实表特性

​		事实表作为数据仓库维度建模的核心，**紧紧围绕着业务过程来设计**，通过获取描述业务过程的度量来表达业务过程，**包含了引用的维度和与业务过程有关的度量**。

**事实表中一条记录所表达的业务细节程度被称为粒度**。**通常粒度可 以通过两种方式来表述:一种是维度属性组合所表示的细节程度:一种 是所表示的具体业务含义**。

作为度量业务过程的事实，一般为整型或浮点型的十进制数值，有 可加性、半可加性和不可加性三种类型。可加性事实是指可以按照与事 实表关联的任意维度进行汇总。半可加性事实只能按照特定维度汇总， 不能对所有维度汇总，比如库存可以按照地点和商品进行汇总，而按时间维度把一年中每个月的库存累 加起来则毫无意义。还有一种度量完全 不具备可加性，比如比率型事实。对于不可 加性事实可分解为可加的组 件来实现聚集。

​		维度属性也可以存储到事实表中，这种存储到事实表中的维度列被称为“退化维度”。与其他存储在维表中的维度一样 ，退化维度也可以 用来进行事实表的过滤查询、实 现聚合操作等。

​		事实表有三种类型 : 事务事实表、周期快照事实表和累积快照事实表。事务事实表用来描述业务过程，跟踪空间或时间上某点的度量事件，保存 的是最原子的数据，也称为“原子事实表“。周期快照事实表以具有规律性的、可预见的时间间隔记录事实 ，时间间隔如每 天、每月、每年等。累积快照事实表用来表述过程 开始和结束之间 的 关键步骤事件 ，覆盖过程的整个生命周期，通常具有 多个日期字段来记录关键时 间点， 当过程 随着生命周期不断变化时，记 录也会随着过程 的变化而被修改。

### 事实表设计原则

**原则 1 :尽可能包含所有与业务过程相关的事实**

**事实表设计的目的是为了度量业务过程**，所以分析哪些事实与业务 过程有关是设计中非常重要的关注点。在事实表中应该尽量包含所有与业务过程相关的事实，即使存在冗余，但是因为事实通常为数字型，带 来的存储开销也不会很大。

**原则 2:只选择与业务过程相关的事实**

在选择事实时，应该注意只选择与业务过程有关的事实。比如在订单的下单这个业务过程的事实表设计中 ，不应该存在支付金额这个表示 支付业务过程的事实。

**原则 3: 分解不可加性事实为可加的组件**

对于不具备可加性条件的事实，需要分解为可加的组件。比如订单 的优惠率，应该分解为订单原价金额与订单优惠金额两个事实存储在事实表中。

**原则 4:在选择维度和事实之前必须先声明粒度**

粒度的声明是事实表设计中不可忽视的重要一步，粒度用于确定 事 实表中一行所表示业务的细节层次，决定了维度模型的扩展性，在选择 维度和事实之前必须先声明粒度，且每个维度和事实必须与所定义的粒 度保持一致。在设计事实表的过程中，粒度定义得越细越好，建议从最低级别的原子粒度开始，因为原子粒度提供了最大限度的 灵活性，可以 支持无法预期的各种细节层次的用户需求。在事实表中，通常通过业务描述来表述粒度，但对于聚集性事实表的粒度描述，可采用维度或维度 属性组合的方式。

**原则 5: 在同一个事实表中不能有多种不同粒度的事实** 

事实表中的所有事实需要与表定义的粒度保持一致，在同 一个事实表中不能有多种不同粒度的事实。

如表 11.1 所示为机票支付成功事务事 实表，**粒度为票一级的**，而 在实际业务中，一个订单可以同时支付多张票，如 ID 为 100901 的订单 包含 三张 机票， ID 为 100902 的订单包含两张机票， ID 为 100903 的订 单包含一张机票。在该事实表的设计中，票支付金额和票折扣金额两个 事实与表定义的粒度一致，并且支持按表的任意维度汇总，可以添加进 该事实表中。而订单支付金额和订单票数作为上 一层粒度的订单级事 实，与该票级事实表的粒度不一致，且不能进行汇总。比如订单 ID 为 100901 的订单支付金额为 3700 元，订单票数为 3 张，如果这两个 度量 在该表进行汇总计算总订单金额和总票数，则会造成重复计算的问题（订单100901的订单支付金额和订单票数会被计算三次） ， 所以不能作为该表的度量选入。

<img src="https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200829234358147.png" alt="image-20200829234358147" style="zoom:50%;" />

**原则 6:事实的单位要保持一致**

对于同 一 个事实表中事实的单位，应该保持一致。比如原订单金额、 订单优惠金额、订单运费金额这三个事实，应该采用一致的计量单位， 统 一 为元或分，以方便使用。

**原则 7: 对事实的 null值要处理**

对于事实表中事实度量为 null 值的处理，因为在数据 库中 null 值 对常用数字型字段的 SQL 过滤条件都不生效，比如大于、小于、等于、 大于或等于、小于或等于，建议用零值填充。

**原则 8:使用退化维度提高事实表的易用性**

在 Kimball 的维度建模中，通常按照星形模型的方式来设计，对于 维度的获取采用的是通过事实表的外键关联专门的维表的方式，谨慎使 用退化维度。而在大数据领域的事实表设计中，则大量采用退化维度的 方式，在事实表中存储各种类型的常用维度信息。这样设计的目的主要 是为了减少下游用户使用时关联多个表的操作，直接通过退化维度实现 对事实表的过滤查询、控制聚合层次、排序数据以及定义主从关系等。 通过增加冗余存储的方式减少计算开销，提高使用效率。

### 事实表设计方法

对于维度模型设计采用四步设计方法: 选择业务过程、声明粒度、确定维度、确定事实。

在当前的互联网大数据环境下，面对复杂的业务场景，为了更有效、 准确地进行维度模型建设，基于 Kimball 的四步维度建模方法，我们进 行了更进一步的改进。

- **第一步 : 选择业务过程及确定事实表类型。**

在明确了业务需求以后，接下来需要进行详细的需求分析，对业务 的整个生命周期进行分析，明确关键的业务步骤，从而选择与需求有关 的业务过程。

以淘宝的正向订单流转为例

![image-20200829235140063](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200829235140063.png)

业务过程通常使用行为动词表示业务执行的活动。比如图 11.l 中 的淘宝订单流转的业务过程有四个:创建订单、买家付款、卖家发货、 买家确认收货。在明确了流程所包含的业务过程后，需要根据具体的业务需求来选择与维度建模有关的业务过程。比如是选择买家付款这个业 务过程，还是选择创建订单和买家付款这两个业务过程，具体根据业务 情况来确定。

在选择了业务过程以后，相应的事实表类型也随之确定了。比如选 择买家付款这个业务过程，那么事实表应为只包含买家付款这一个业务过程的单事务事实表;如果选择的是所有四个业务过程，并且需要分析 各个业务过程之间的时间间隔，那么所建立的事实表应为包含了所有四个业务过程的累积快照事实表。

- **第二步:声明粒度。**

粒度的声明是事实表建模非常重要的一步，意味着精确定义事实表 的每一行所表示的业务含义，粒度传递的是与事实表度量有关的细节层 次。明确的粒度能确保对事实表中行的意思的理解不会产生混淆，保证 所有的事实按照同样的细节层次记录。

应该尽量选择最细级别的原子粒度，以确保事实表的应用具有最大 的灵活性。同时对于订单过程而言，粒度可以被定义为最细的订单级别。 比如在淘宝订单中有父子订单的概念，即一个子订单对应一种商品，如 果拍下了多种商品，则每种商品对应一个子订单:这些子订单一同结算 的话，则会生成一个父订单。那么在这个例子中，事实表的粒度应该选 择为子订单级别。

- **第三步 : 确定维度 。**

完成粒度声明以后，也就意味着确定了主键，对应的维度组合以及 相关的维度字段就可以确定了，应该选择能够描述清楚业务过程所处的 环境的维度信息。比如在淘宝订单付款事务事实表中，粒度为子订单， 相关的维度有买家、卖家、商品、收货人信息 、 业务类型、订单时间等 维度。

- **第四步 ：确定事实 。**

事实可以通过回答“**过程的度量是什么**”来确定。应该选择与业务 过程有关的所有事实，且事实的粒度要与所声明的事实表的粒度一致。 事实有可加性、半可加性、非可加性三种类型 ， 需要将不可加性事实分 解为可加的组件。

比如在淘宝订单付款事务事实表中，同粒度的事实有子订单分摊的支付金额、邮费、优惠金额等。

- **第五步 . 冗余维度 。** 

在传统的维度建模的星形模型中，对维度的处理是需要单独存放在专门的维表中的，通过事实表的外键获取维度。这样做的目的是为了减少事实表的维度冗余，从而减少存储消耗。而在大数据的事实表模 型设 计中，考虑更多的是提高下游用户的使用效率，降低数据获取的复杂性， 减少关联的表数量。所以通常事实表中会冗余方便下游用户使用的常用 维度，以实现对事实表的过滤查询、控制聚合层次、排序数据以及定义 主从关系等操作。

比如在淘宝订单付款事务事实表中，通常会冗余大 量的常用维度字 段，以及商品类目、卖家店铺等维度信息。

## 事务事实表

​		订单作为交易行为的核心载体，直观反映了交易的状况。订单的 流 转会产生很多业务过程，而下单、支付和成功完结三个业务过程是整个 订单的关键节点。获取这三个业务过程的笔数、金额以及转化率是日常 数据统计分析的重点，事务事实表设计可以很好地满足这个需求。本节 将介绍三种不同事务事实表的设计方式，以及在淘宝交易订单中关于邮 费和折扣分摊到子订单的算法。

### 设计过程

​		任何类型的事件都可以被理解为一种事务。比如交易过程中的创建 订单、买家付款，物流过程中的揽货、发货、签收，退款中的申请退 款、 申请小 二 介入等，都可以被理解为 一 种事务。事务事实 表， 即针对这些 过程构建的一类事实表，用以跟踪定义业务过程的个体行为，提供丰富 的分析能力，作为数据仓库原子的明细数据。下面以淘 宝交易事务事实表为例，阐述事务事实表的一般设计过程。

#### 选择业务过程

​		图 11.1 给出了淘宝交易订单的流转过程，其中介绍了四个重要过程:创建订单、买家 付款、 卖家发货、买家 确认收货，即下单、支付 、 发货和成功完结四个业务过程。这四个业务过程不仅是交易过程中的重要时间节点 ，而且也是下游统计分析的重点，因此淘宝交易事务事实表 设计着重从这四个业务过程进行展开 。

Kimball 维度建模理论认为，为了便于进行独立的分析研究，应该 为每个业务过程建立一个事实表。 对于是否将不同业务过程放到同 一个 事实表 中，将在下 一节 中详细介绍。

#### 确定粒度

​		业务过程选定以后，就要针对每个业务过程确定一个粒度，即确定事务事实表每一行 所表达的细节层次。下面先介绍淘宝订单的产生过程。

​		淘宝出售商品主要分两类卖家 : 一类是个人性质的闲置卖家，主要出售闲置的或者二手商品 : 一类是拥有店铺的卖家，以出售新商品为主。 接下来主要以店铺类交易订单为例进行介绍。在淘宝下单交易时，有两 种方式:一种是选定商品后直接购买，这样会产生一个交易订单;一种 是将多 种商品加入到购物车中，然后一起结算，此时对于每一种商品都会 产生一个订单 ，同时对于同一个店铺会额外产生一个订单，即父订单;由 于是在同一个店铺购买的，所以父订单会承载订单物流、店铺优惠等信息。 而对于每一种商品产生的订单就称为子订单，子订单记录了父订单的订单 号，并且有子订单标志。 如果在同一个店铺只购买了一种商品，则会将父 子订单进行合并，只保留一条订单记录。如图 11.2和图 11.3所示示例。

![image-20200830111414820](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200830111414820.png)

了解了淘宝交易订单的产生过程后，现在为淘宝交易事务事实表确定粒度。 如第 l 步所述，在淘宝交易过程中有四个重要业务过程，需要 为每个业务过程确定一个粒度。其 中下单、支付和成功完结三个业务过 程选择**交易子订单粒度** ，即每个子订单为事务事实表的一行，每个子订 单所表达 的细节信息为: 交易 时间、卖家、买家、商品，即选择图 l1.2 和图11.3中订单ID为1、 4、 5' 6、 7、 8, 9的子订单作为事务事实表 的每一行。卖家发货这个业务过程可以选择子订单粒度，即将每个子订 单作为卖家发货事实表 的一个细节。然而，在实际操作中发现，卖家发 货更多 的是物流单粒度而非子订单粒度，同 一个子订单可以拆开成多个 物流单进行发货。在事务事实表设 计过程中，秉承确定为最细粒度的原则，因此对于卖家发货确定为物流单粒度，和其他三个业务过程不同，

这样可以更好地给下游统计分析带来灵活性。

#### 确定维度

选定好业务过程并且确定粒度后，就可以确定维度信息了。在淘宝交 易事务事实表设计过程中，**按照经常用于统计分析的场景，确定维度**包含: 买家、卖家、商品、商品类目、发货地区、收货地区、父订单维度以及杂 项维度。由于订单的属性较多，比如订单的业务类型、是否无线交易、订 单的 attributes 属性等，对于这些使用较多却又无法归属到上述买卖家或商 品维度中的属性，则新建一个**杂项维度**进行存放，如图 l1.4所示。

![image-20200830143950581](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200830143950581.png)

#### 确定事实

​		作为过程度量的核心，事实表应该包含与其描述过程有关的所有事 实。以淘宝交易事务事实表为例，选定 三个业务过程一一下单、支付和 成功完结，不同的业务过程拥有不同的事实。比如在下单业务过程中， 需要包含下单金额、下单数量、下单分摊金额;在支付业务过程中，包 含支付金额、分摊邮费、折扣金额、红包金额、积分金额;在完结业务 过程中包含确认收货金额等。由于粒度是子订单，所以对于一些父订单 上的金额需要分摊到子订单上，比如父订单邮费、父订单折扣等。具体 的分摊算法将在“父子事实的处理方式” 一 节中介绍。

#### 冗余维度

在确定维度时，包含了买卖家维度、商品维度、类目维度 、收发货 维度等， Kimball维度建模理论建议在事实表中只保存这些维表的外键， 而淘宝交易事务事实表在 Kimball 维度建模基础之上做了进 一 步的优 化，将买卖家星级、标签、店铺名称、商品类型、商品特征、商 品属性、 类 目层级等维度属性都冗余到事实表中，提高对事实表进行过滤查询、统计聚合的效率，如图 l1.5 所示 。

![image-20200830144151763](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200830144151763.png)

#### 单事务事实表

​		单事务事实表，顾名思义，即针对每个业务过程设计一个事实表。这样设计的优点不言而喻，可以方便地对每个业务过程进行独立的分析研究。 1688 交易流程则采用这 种模式构建事务事实表。

​		1688 交易和淘宝交易相 似，主要流程也是下单、支付、发货和完 结，而在这四个关键流程中 1688 交易选择 下单和支付两个业务过程设 计事务事实表，分别是 **1688交易订单下单事务事实表**和 **1688交易订单 支付事务事实表**。

​		选定业务过程后，将对每个业务过程确定粒度、维度和事实。对于 1688 交易订单下单事务事实表，确定子订单粒度，选择买家、卖家、商品、父订单、收货地区维度，事实包含下单分摊金额 和折扣金额，如 图11 .6 所示:而对于 1688 交易订单支付事务事实表 ，粒度和维度与交 易订单下单事务事实表相同，所表达的事实 则不 一样 ，包含支付金额、支付调整金额和支付优惠等，如图11.7 所示

![image-20200830144832482](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200830144832482.png)



​		1688 交易针对下单和支付分别建立单事务事实表后，每天的下单记录则进入当天的下单事务事实表 中，每天的支付记录进入当天的支付事务事实表中，由于事实表具有稀疏性质 ，因此只有当天数据才会进入当天的事实表中。下面以具体交易订单为例 ，展示单事务事实表的设计实例。

​		如图 11.8 所示， orderl 在 2016-01-01 下单并且在当天完成支付; order2 和 order3 在 2016-01-01 下单并且在 2016-01-02 完成支付。如图 11.9 和图 11. 10 所示， order1、 order2 和 order3 写入下单事务事实表中， 业务日期(下单日期)均为 2016-01-01; orderl、 order2 和 order3 也分别写入支付事务事实表中，业务日期(支付日期)分别为 2016-01-0I 、 2016-01-02 和 2016-01-02。

![image-20200830145033388](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200830145033388.png)

#### 多事务事实表

多事务事实表 ， 将不同的事实放到同一个事实表中，即同一个事实 表包含不 同的业务过程。多事务事实表在设计时有两种方法进行事实的处理 : 1不同业务过程的事实使用**不同的事实字段**进行存放:2不同业 务过程的事实使用同一个事实字段进行存放，但增加 一 个**业务过程标签**。

如何选择：

- 当不同业务过程的度量比较相似、差异不大时，可以采用第 二种 多事务事实表的设计方式，使用同 一个字段来表示度量数据 。但 这种方式存在一个问题一一-在同一个周期内会存在多条记录。

-  当不同业务过程的度量差异较大时，可以选择第一种多事务事实 表的设计方式，将不同业务过程的度量使用不同 字段冗余到 表 中，非当前业务过程则置零表示。这种方式所存在的问题是度量字段零值较多。

#### 两种事实表对比

1. **业务过程**

对于单事务事实表，一个业务过程建立一个事实表，只反映一个业务过程的事实 ；对于多事务事实表，在同 一个事实表 中反映多个业务过 程。多个业务过程是否放到同一 个事实表中，首先需要分析不同业务过 程之间的相 似性和业务源系统。比如淘宝交易的下单、支付和成功完结 这三个**业务过程是存在相似性的**，都属于订单处理中的 一环，并且都来自于交易系统 ，因此适合放到同 一个事务事实表 中。 

2. **粒度和维度**

在考虑是采用单事务事实表还是多事务事实表时，另一个关键点就是粒度和维度，在确定好 业务过程后，需要基于不同的业务过程确定粒 度和维度，**当不同 业务过程的粒度相同，同时拥有相似的维度时，此时 就可以考虑采用多事务事实表。 如果粒度不同，则必定是不同的事实表**。 比如交易中支 付和发货有不同的粒度，则无法将发货业务过程放到淘宝 交易事务事实表 中。

3. **事实**

对于不同的业务过程，事实往往是不同的，单事务事实表在处理事实上 比较方便和灵活，仅仅体现同 一个业务过程的事实即可， 而多事务 事实表由于有多个业务过程， 所以有更多的事实需要处理。如果单一业 务过程 的事实较多，同时不同业务过程的事实又不相同，则可以考虑使 用单事务事实表，处理更加清晰 ; 若使用多事务事实表， 则 会导致事实 表零值或空值字段较多。

4. **下游业务使用**
    单事务事实表对于下游用户而言更容易理解 ， 关注哪个业务过程就使用相应的事务事实表;而多事务事实表包含多个业务过程，用户使用时往往较为困惑。 1688 和淘宝交易分别采用了这两种方式，从日常使 用来看，对于淘宝交易事务事实表下游用户确实有 一定的学习成本 。

5. **计算存储成本**

   针对多个业务过程设计事务事实表，是采用单事务事实表还是多事务事实表，对于数据仓库的计算存储成本也是参考点之 一 ，当业务过程 数据来源于同 一个业务系统，具有相同的粒度和维度，且维度较多而事 实相对不多时，此时可以考虑使用多事务事实表，不仅其加工计算成本 较低，同时在存储上也相对节省，是一种较优的处理方式。

![image-20200830151814632](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200830151814632.png)

#### 事实的设计准则

**1 . 事实完整性**

事实表包含与其描述的过程有关的所有事实，即尽可能多地获取所 有的度量。在淘宝交易事务事实表中，比如支付业务过程，在子订单粒 度上的支 付金额、支付邮费、支付红包、支付积分、支付折扣都有所包 含 ，覆盖全面。

2. **事实一致性**

在确定事务事实表的事实时，明确存储每一个事实以确保度量的 一 致性。以淘宝交易事务事实表为例 ，在下单业务过程中，有下单商品数 量和商品价格两个事实，但在事实表中计算了下单金额和下单有效金额，它们可以通过商品数量乘以商品价格进行计算。虽然下游在取数时也可以通过这种方式完成计算，但是在事实表中统一计算可以保证度量的一致性，其他如支付过程中的分摊金额等也是类似的。

3. **事实可加性**

事实表确定事实时，往往会遇到非可加性度量，比如分摊比例、 利 润率等，虽然它们也是下游分析的关键点，但往往在事务事实表中 关注 更多的是可加性事实，下游用户在聚合统计时更加方便。在淘宝交易 事 务事实表中，存储了分摊比例这样的度量，但更多的是存储各类金额的 度量。

## 周期快照事实表

​		前面章节对事务事实表进行了详细的阐述，同时给出了淘宝交易事 务事实表的设计过程。事务事实表可以很好地跟踪一个事件，并对其进 行度量，以提供丰富的分析能力。然而，当需要一些**状态度量**时，比如 账户余额、买卖家星级 、 商品库存、卖家累积交易额等，则需要**聚集与之相关的事务**才能进行识 别计算 ;或者聚集事务无法识别 ，比如温度 等。对于这些状态度量，事务事实表是无效率的，而这些度量也和度量 事务本身一样是有用的 ，因此， 维度建模理论给出了第二种常见的事实 表一一周期快照事实表，简称“**快照事实表**”。快照事实表在确定的间隔内对实体的度量进行抽样，这样可以很容易地研究实体的度量值，而 不需要聚集长期 的事务历史。接下来将以淘宝交易结束后的评价数据、 卖家的累积支付金额、买卖家星级等事实表的设计为例，介绍快照事实 表在阿里 巴巴数据仓 库中的设计与应用。

### 特性

​		快照事实表的设计有 一些 区别于事务事实表设计的性质。**事务事实表的粒度能以多种方式表达，但快照事实表的粒度通常以维度形式声明；事务事实表是稀疏的，但快照事实表是稠密的 ; 事务事实表中的事 实是完全 可加的，但快照模型将至少包含一个用来展示半可加性质的事 实。**

​		**为什么事务事实表具有稀疏性质？**[why](https://blog.csdn.net/a6822342/article/details/99189806)

*事实表一般围绕着度量来建立，当度量产生的时候，事实记录就生成了。度量可以是销售数量、交易流水值、月末节余等数值。如果同时生成多个度量值的话，我们可以在一个事实表中建立多个事实。当我们的事实表中的事实比较多时，**有可能多个事实不同时发生，如果同时生成的几率很小，我们称之为稀疏事实表**（Sparse Facts）。如果事实表非常稀疏，可以考虑采用[事实维度表*](http://wenda.tianya.cn/answer/1eb54dc6c0a17b11000481a632d86094)

1. 用快照采样状态

**快照事实表以预定的间隔采样状态度量。这种间隔联合一个或多个 维度，将被用来定义快照事实表的粒度，每行都将包含记录所涉及状态 的事实。**

现在以淘宝交易卖家自然年汇总事实表为例进行介绍。淘宝活动运营小二或者卖家经常 都需要看 一 些交易状态数据，比如自然年至今或者 历史至今 的下单金额、支付金额、支付买家数、支付商品件数等状态度 量，对于卖家而言 ，可能每天早上都想看 一 下截至昨天的成交情况;对 于小二 而 言 ，可能在频繁的活动周期就需要查看 一 次成交情况。这些状 态度量可以每天通过事务事实表进行聚集，但随着时间跨度变大聚集 效率会越来越低 ，因此需要设计快照事实表进行状态的度量，这里用于采样的周期间隔是每天，如图 11.16所示的快照事实表记录了每个卖家 的下单和支付情况。

![image-20200830154859152](https://piggo-picture.oss-cn-hangzhou.aliyuncs.com/image/image-20200830154859152.png)

2. 快照粒度

事务事实表的粒度可以通过业务过程中所涉及的细节程度来描述， 但快照事实表的**粒度**通常总是被多维声明，可以简单地理解为**快照需要采样的周期以及什么将被采样**。在淘宝交易卖家快照事实表中，粒度可 以被理解为每天针对卖家的历史截至当日的下单支付金额进行快照。当然，快照周期不一定都按天来进行，也可以按照月或者季度来统 计。比如淘宝交易有针对卖家加类目的每月汇总事实表，每月统计 一次， 同时维度也不仅一个，包含了卖家和类目。

3. 密度与稀疏性

快照事实表和事务事实表的一个关键区别在密度上。事务事实表是 稀疏的，只有当天发生的业务过程，事实表才会记录该业务过程的事 实， 如下单、支付等;而快照事实表是稠密的，无论当天是否有业务过程发 生，都会记录一行，比如针对卖家的历史至今的下单和支付金额，无论 当天卖家是否有下单支付事实，都会给该卖家记录一行。稠密性是快照 事实表的重要特征，如果在每个快照周期内不记录行，比如和事务事实 表一样 ，那么确定状态将变得非 常困难。
